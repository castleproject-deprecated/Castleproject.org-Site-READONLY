<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">









<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
		<title>MonoRail Services Architecture :: Castle Project</title>
		<link rel="stylesheet" href="../../../../base.css" />
		<link rel="stylesheet" href="../../../../front.css" />
		<link rel="stylesheet" href="../../../../elem.css" />
		<link rel="stylesheet" href="../../../../csharp.css" />
		<link rel="stylesheet" href="../../../../TAB_styles.css" />
		<script type="text/javascript" src="../../../../mktree.js"></script>
		<script type="text/javascript" src="../../../../TAB_Function_Lib.js"></script>
		<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script>
	</head>

	<body>
<div id="topheader">
  <div id="maintitle">
	<h1> <a href="../../../../index.html" title="Castle Project Home" accesskey="1">Home</a> </h1>
	<h2> <a href="http://www.castlestronghold.com" title="Castle Stronghold: support, consulting and development">Castle Stronghold</a> </h2>
  </div>
  <div id="mainbar">
	<ul id="toplinks">
		<li>&nbsp;</li>
		<li><a style="_width: 70px;" href="../../../../index.html">Home</a></li>
		<li><a style="_width: 70px;" href="../../../../castle/download.html">Download</a></li>
		<li><a style="_width: 110px;" href="http://api.castleproject.org">API Doc</a></li>
		<li><a style="_width: 50px;" href="http://using.castleproject.org">Using</a></li>
		<li><a style="_width: 60px;" href="../../../../community/forum.html">Forum</a></li>
		<li><a style="_width: 120px;" href="../../../../jira.html">Jira/Issue tracker</a></li>
		<li><a style="_width: 110px;" href="http://builds.castleproject.org">Builds</a></li>
	</ul>
  </div>
</div>



<div id="coolpage">

	<div id="sidebar" >
		
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../monorail/index.html">MonoRail</a>
</span>
  <ul>
<li>
<a href="./../../../../monorail/gettingstarted/index.html">Getting started</a>
</li>
<li>
<a href="./../../../../monorail/faq.html">FAQ</a>
</li>
<li>
<a href="./../../../../monorail/recipes/index.html">Recipes</a>
</li>
<li>
<a href="./../../../../monorail/externalarticles.html">External Articles</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../monorail/documentation/v1rc2/index.html">Documentation</a>
</span>
  <ul>
<li>
<a href="./../../../../monorail/documentation/v1rc2/releasenotes/index.html">Release notes</a>
</li>
<li>
<a href="./../../../../monorail/documentation/v1rc2/manual/index.html">Reference Manual</a>
</li>
<li>
<a href="./../../../../monorail/documentation/v1rc2/usersguide/index.html">User's Guide</a>
</li>
<li>
<a href="./../../../../monorail/documentation/v1rc2/advanced/index.html">Advanced usage</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="darkmenu">
    <div class="darkmenucontent">
<span class="menutitle">
Navigation
</span>
  <ul>
<li>
<a href="./../../../../index.html">Back to Main Page</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
	<br/>
	
	</div>
		
	<div id="content">
	
		<div class="callout-pic">

<!-- Begin Table of contents -->
<div id="toc">
<h2>Table of contents</h2>
<ul>
<li class='toclevel-1'><a href="#StatingTheProblem"><span class="tocnumber">1</span> <span class="toctext">Stating the problem</span></a>
</li>
<li class='toclevel-1'><a href="#AnApproachToThisProblem"><span class="tocnumber">2</span> <span class="toctext">How MonoRail tackles this problem</span></a>
</li>
<li class='toclevel-1'><a href="#Flow"><span class="tocnumber">3</span> <span class="toctext">How it works</span></a>
</li>
<li class='toclevel-1'><a href="#Flow"><span class="tocnumber">4</span> <span class="toctext">The initialization flow</span></a>
</li>
<li class='toclevel-1'><a href="#Lifecycle"><span class="tocnumber">5</span> <span class="toctext">Lifecycle interfaces</span></a>
<ul>
	<li class='toclevel-1'><span class="tocnumber">5.1</span> <span class="toctext">Invocation order</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">5.2</span> <span class="toctext">The expected (good) behavior from a service implementation</span>
</li>
</ul>
</li>
<li class='toclevel-1'><a href="#Services"><span class="tocnumber">6</span> <span class="toctext">Built-in services</span></a>
<ul>
	<li class='toclevel-1'><span class="tocnumber">6.1</span> <span class="toctext">MonoRailConfiguration</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.2</span> <span class="toctext">ExtensionManager</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.3</span> <span class="toctext">IViewSourceLoader</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.4</span> <span class="toctext">IViewEngine</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.5</span> <span class="toctext">IScaffoldingSupport</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.6</span> <span class="toctext">IControllerFactory</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.7</span> <span class="toctext">IViewComponentFactory</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.8</span> <span class="toctext">IFilterFactory</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.9</span> <span class="toctext">IResourceFactory</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.10</span> <span class="toctext">IEmailSender</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.11</span> <span class="toctext">IEmailTemplateService</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.12</span> <span class="toctext">IControllerDescriptorProvider</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.13</span> <span class="toctext">IResourceDescriptorProvider</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.14</span> <span class="toctext">IRescueDescriptorProvider</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.15</span> <span class="toctext">ILayoutDescriptorProvider</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.16</span> <span class="toctext">IHelperDescriptorProvider</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.17</span> <span class="toctext">IFilterDescriptorProvider</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.18</span> <span class="toctext">IControllerTree</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">6.19</span> <span class="toctext">ICacheProvider</span>
</li>
</ul>
</li>
<li class='toclevel-1'><span class="tocnumber">7</span> <span class="toctext">Registering services</span>
</li>
</ul>
</div>
<!-- End Table of contents -->
		</div>

		<h1 class="firstHeading">
		    MonoRail Services Architecture
		</h1> 
	
<div class="breadcrumbs">
&raquo;
	<a href="./../../../../index.html">Home</a> 
&raquo;
	<a href="./../../../../monorail/index.html">MonoRail</a> 
&raquo;
	<a href="./../../../../monorail/documentation/index.html">Documentation</a> 
&raquo;
	<a href="./../../../../monorail/documentation/v1rc2/index.html">MonoRail RC2 Documentation</a> 
&raquo;
	<a href="./../../../../monorail/documentation/v1rc2/advanced/index.html">Advanced usage</a> 
&raquo;
<u>MonoRail Services Architecture</u>
</div>

		<!-- start content -->
<p>
MonoRail uses a set of services to handle specific tasks. The framework
is responsible for defining the default implementations, instantiate,
start and configure them. The services are made available through a combination
of lifecycle interfaces and an implementation of <tt>IServiceProvider</tt></p><a name="StatingTheProblem"></a>
  <h1>Stating the problem</h1>
<p>
It's impossible to come up with a sophisticated software
where the default behavior pleases everyone and integrates with everything.
The usual solution is making the software rely on contracts and
having the core code as just a coordination of invocations on the contracts
implementation. An user is thus capable of replacing one or more
contract implementation.
</p><p>
The challenging is implementing an architecture where 
the parts are easily replaced, configurable and can rely (depend) on 
other parts.
</p><a name="AnApproachToThisProblem"></a>
  <h1>How MonoRail tackles this problem</h1>
<p>
The most usual solution to this problem is to use an Inversion of
Control container. However, things have to be balanced. For MonoRail, 
an IoC container would introduce dependencies on assemblies
and an longer initialization. In the end, we wouldn't benefit from
all IoC container features, so it could be considered too much for our problem.
</p><p>
Instead, we combined what is already on the .Net library
and some creative solution. 
</p><p>
Basically we create two levels of services registries, per application and per request,
and a simple interfaces that defines lifecycles that services optionally implement.
This allow the service to start its work when it is supposed to and to 
gather reference to other services.
</p><a name="Flow"></a>
  <h1>How it works</h1>
<p>
When the web application is started, the ASP.Net modules are initialized. 
MonoRail has a <tt>EngineContextModule</tt> which is in charge of 
</p><ul><li>Read the configuration</li><li>Initialize the services</li><li>Subscribe to ASP.Net application and request level events</li><li>Create a request context (which we'll not cover here)</li></ul><p>
Services implementation can be defined in the configuration section. 
After reading the configuration section MonoRail checks for missing definition
and register the missing services using the default implementation.
</p><p>
After that it instantiates every service and runs the lifecycle. If everything
went well, the framework is properly initialized. All services are registered in 
the application level container, which happens to be implemented by 
the <tt>EngineContextModule</tt> class. We call this the parent container.
</p><p>
When a request starts, MonoRail creates a <tt>DefaultRailsEngineContext</tt> 
instance, which also is a container for services. MonoRail sets the parent 
container on it. This allow the user to override services per request, and 
resolution of services in the parent.
</p><a name="Flow"></a>
  <h1>The initialization flow</h1>
<p><img src="../images/monorail/mr_services_1.png" ></img></p><p><ol><li>The configuration is read into the <tt>MonoRailConfiguration</tt>. It's also registered as a service</li><li>The services collected are instantiated and registered</li><li>The lifecycle is executed</li></ol></p><a name="Lifecycle"></a>
  <h1>Lifecycle interfaces</h1>
<p>
A service might implement a few interfaces to expose to MonoRail
that it behaves in a specific way or that it needs something 
from the framework.
</p><p><b>ISupportInitialize (from System.ComponentModel)</b><p>This interface can be implemented if a service wants performs some initialization.</p></p><p><b>IInitializable (from Castle.Core)</b><p>This interface can be implemented if a service wants performs some initialization.</p></p><p><b>IServiceEnabledComponent (from Castle.Core)</b><p>This interface can be implemented if a service uses other services.</p></p>  <h2>Invocation order</h2>
<p><tt>IServiceEnabledComponent</tt> is the first one to be invoked. This gives a 
chance to services gather all services references it wants. Then the initialization 
interface's methods are invoked.
</p>  <h2>The expected (good) behavior from a service implementation</h2>
<p>
For service that uses <tt>IServiceEnabledComponent</tt> lifecycle, the implementor
should keep in mind that the initialization lifecycle has not run for all
services, so it might not be safe to use other services as they might not be properly
initialized at the moment.
</p><p>
The order of service registration and instantiation is not guaranted. So the 
implementor should not make any assumption regarding it.
</p><a name="Services"></a>
  <h1>Built-in services</h1>
<p>
The following is a succint list of services and their roles. You can
refer to this list to learn more about MonoRail inner workings
or to use them when developing extensions and new services.
</p>  <h2>MonoRailConfiguration</h2>
<p>Exposes the MonoRail configuration</p>  <h2>ExtensionManager</h2>
<p>Manages registered extensions dispatching events from Asp.Net infrastructure
	and from MonoRail services</p>  <h2>IViewSourceLoader</h2>
<p>Sits in front of the file system and from assembly resources. It
	is used by view engines to obtain view streams</p>  <h2>IViewEngine</h2>
<p>Process view templates</p>  <h2>IScaffoldingSupport</h2>
<p>Adds scaffold support to a controller</p>  <h2>IControllerFactory</h2>
<p>Creates the controller instances</p>  <h2>IViewComponentFactory</h2>
<p>Manages registered ViewComponents and creates their instances</p>  <h2>IFilterFactory</h2>
<p>Manages registered filters and creates their instances</p>  <h2>IResourceFactory</h2>
<p>Create resources</p>  <h2>IEmailSender</h2>
<p>Sends e-mail</p>  <h2>IEmailTemplateService</h2>
<p>Process e-mail templates using the MonoRail infrastructure</p>  <h2>IControllerDescriptorProvider</h2>
<p>Inspects Controller types building a descriptor of what has been defined using attributes</p>  <h2>IResourceDescriptorProvider</h2>
<p>Creates descriptors for resources declared on controllers</p>  <h2>IRescueDescriptorProvider</h2>
<p>Creates descriptors for rescues declared on controllers</p>  <h2>ILayoutDescriptorProvider</h2>
<p>Creates descriptors for layouts declared on controllers</p>  <h2>IHelperDescriptorProvider</h2>
<p>Creates descriptors for helpers declared on controllers</p>  <h2>IFilterDescriptorProvider</h2>
<p>Creates descriptors for filters declared on controllers</p>  <h2>IControllerTree</h2>
<p>Manages a binary tree of controllers registered</p>  <h2>ICacheProvider</h2>
<p>Manages the cache</p>  <h1>Registering services</h1>
<p>
You have to use the <tt>monorail</tt> configuration node
to override or add services to MonoRail.
</p>		<!-- end content -->
		
	<div id="footer">
<script type="text/javascript"><!--
google_ad_client = "pub-2091974950947714";
/* 728x90, created 2/13/08 */
google_ad_slot = "5378217716";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

	Found an error? Something inaccurate? 
	<a href="../../../../community/getinvolved.html">Help us improve the documentation</a> <br/>
	Generated by <a href="../../../../others/anakia/index.html">Castle Anakia</a>. 
	
	<p>&nbsp;</p>
	
	<p>
	Sponsored by <img src="../../../../images/logothumb.gif" /> <a href="http://www.castlestronghold.com">Castle Stronghold</a>.
	</p>
	
	</div>

	<!-- Search Google -->
<center>
<FORM method=GET action="http://www.google.com/custom">
<TABLE bgcolor="#FFFFFF" cellspacing="4" border="0" style="border: solid 1px gray;" align="center">
<tr valign=top><td>
<A HREF="http://www.google.com/search">
<IMG SRC="http://www.google.com/logos/Logo_40wht.gif" border=0 ALT=Google align=middle></A>
</td>
<td>
<INPUT TYPE=text name=q size=31 maxlength=255 value="">
<INPUT type=submit name=sa VALUE="Google Search">
<INPUT type=hidden name=cof VALUE="S:http://www.castlestronghold.com;GL:1;VLC:#373737;AH:center;LH:63;LC:#0A50A1;GFNT:#5B5B5B;L:http://www.castleproject.org/images/castle-logo.gif;ALC:#0A50A1;BIMG:http://www.castleproject.org/images/bg.png;LW:280;T:#5B5B5B;AWFID:3d565acacdd9f388;">
<input type=hidden name=domains value="castleproject.org"><br><input type=radio name=sitesearch value=""> Search WWW <input type=radio name=sitesearch value="castleproject.org" checked> Search castleproject.org
</td></tr></TABLE>
</FORM>
<!-- Search Google -->
</center>
	&nbsp;
	<br/>

		</div> <!-- end of content -->
  </div><!-- end of page -->
  


	<script type="text/javascript">_uacct = "UA-1190612-1";urchinTracker();</script>
	</body>
</html>
