<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">









<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
		<title>ActiveRecord Integration :: Castle Project</title>
		<link rel="stylesheet" href="../../../../base.css" />
		<link rel="stylesheet" href="../../../../front.css" />
		<link rel="stylesheet" href="../../../../elem.css" />
		<link rel="stylesheet" href="../../../../csharp.css" />
		<link rel="stylesheet" href="../../../../TAB_styles.css" />
		<script type="text/javascript" src="../../../../mktree.js"></script>
		<script type="text/javascript" src="../../../../TAB_Function_Lib.js"></script>
		<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script>
	</head>

	<body>
<div id="topheader">
  <div id="maintitle">
	<h1> <a href="../../../../index.html" title="Castle Project Home" accesskey="1">Home</a> </h1>
	<h2> <a href="http://www.castlestronghold.com" title="Castle Stronghold: support, consulting and development">Castle Stronghold</a> </h2>
  </div>
  <div id="mainbar">
	<ul id="toplinks">
		<li>&nbsp;</li>
		<li><a style="_width: 70px;" href="../../../../index.html">Home</a></li>
		<li><a style="_width: 70px;" href="../../../../castle/projects.html">Projects</a></li>
		<li><a style="_width: 70px;" href="../../../../castle/download.html">Downloads</a></li>
		<li><a href="#" onclick="UserVoice.Popin.show(); return false;" title="Uservoice Feedback">Feedback</a></li>
		<li><a style="_width: 110px;" href="http://api.castleproject.org">API Doc</a></li>
		<li><a style="_width: 50px;" href="http://using.castleproject.org">Using</a></li>
		<li><a style="_width: 60px;" href="../../../../community/mailinglists.html">Mailing Lists</a></li>
		<li><a style="_width: 120px;" href="../../../../issuetracker.html">Issue Tracker</a></li>
		<li><a style="_width: 110px;" href="http://builds.castleproject.org">Builds</a></li>
	</ul>
  </div>
</div>



<div id="coolpage">

	<div id="sidebar" >
		
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../monorail/index.html">MonoRail</a>
</span>
  <ul>
<li>
<a href="./../../../../monorail/gettingstarted/index.html">Getting started</a>
</li>
<li>
<a href="./../../../../monorail/faq.html">FAQ</a>
</li>
<li>
<a href="./../../../../monorail/recipes/index.html">Recipes</a>
</li>
<li>
<a href="./../../../../monorail/externalarticles.html">External Articles</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../monorail/documentation/trunk/index.html">Documentation</a>
</span>
  <ul>
<li>
<a href="./../../../../monorail/documentation/trunk/releasenotes/index.html">Release notes</a>
</li>
<li>
<a href="./../../../../monorail/documentation/trunk/manual/index.html">Reference Manual</a>
</li>
<li>
<a href="./../../../../monorail/documentation/trunk/usersguide/index.html">User's Guide</a>
</li>
<li>
<a href="./../../../../monorail/documentation/trunk/advanced/index.html">Advanced usage</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="darkmenu">
    <div class="darkmenucontent">
<span class="menutitle">
Navigation
</span>
  <ul>
<li>
<a href="./../../../../index.html">Back to Main Page</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
	<br/>
	
	</div>
		
	<div id="content">
	
		<div class="callout-pic">

<!-- Begin Table of contents -->
<div id="toc">
<h2>Table of contents</h2>
<ul>
<li class='toclevel-1'><a href="#ARSmartDispatcherController"><span class="tocnumber">1</span> <span class="toctext">ARSmartDispatcherController</span></a>
</li>
<li class='toclevel-1'><a href="#ARDataBindAttribute"><span class="tocnumber">2</span> <span class="toctext">ARDataBindAttribute and ARDataBinder class</span></a>
</li>
<li class='toclevel-1'><a href="#AutoLoad"><span class="tocnumber">3</span> <span class="toctext">The AutoLoad property</span></a>
</li>
<li class='toclevel-1'><a href="#DataBindIssues"><span class="tocnumber">4</span> <span class="toctext">ActiveRecord DataBinding Issues</span></a>
<ul>
	<li class='toclevel-1'><a href="#readonlysession"><span class="tocnumber">4.1</span> <span class="toctext">Using a Read-Only-Session</span></a>
</li>
	<li class='toclevel-1'><a href="#evicting"><span class="tocnumber">4.2</span> <span class="toctext">Removing Invalid Objects From Session</span></a>
</li>
	<li class='toclevel-1'><a href="#transactionrollback"><span class="tocnumber">4.3</span> <span class="toctext">Using a TransactionScope</span></a>
</li>
	<li class='toclevel-1'><a href="#validation"><span class="tocnumber">4.4</span> <span class="toctext">Use Validation during DataBinding</span></a>
</li>
</ul>
</li>
<li class='toclevel-1'><a href="#ARFetch"><span class="tocnumber">5</span> <span class="toctext">ARFetchAttribute</span></a>
</li>
</ul>
</div>
<!-- End Table of contents -->
		</div>

		<h1 class="firstHeading">
		    ActiveRecord Integration
		</h1> 
	
<div class="breadcrumbs">
&raquo;
	<a href="./../../../../index.html">Home</a> 
&raquo;
	<a href="./../../../../monorail/index.html">MonoRail</a> 
&raquo;
	<a href="./../../../../monorail/documentation/index.html">Documentation</a> 
&raquo;
	<a href="./../../../../monorail/documentation/trunk/index.html">MonoRail trunk Documentation</a> 
&raquo;
	<a href="./../../../../monorail/documentation/trunk/integration/index.html">Integrations</a> 
&raquo;
<u>ActiveRecord Integration</u>
</div>

		<!-- start content -->
<p>
If you are using ActiveRecord you 
may consider using the integration we developed fo it. 
In order to do so, first of all, add a reference to the following assembly:
</p><p><ul><li> Castle.MonoRail.ActiveRecordSupport </li></ul></p><a name="ARSmartDispatcherController"></a>
  <h1>ARSmartDispatcherController</h1>
<p>
What we are about to discuss only works 
if you are using <tt>ARSmartDispatcherController</tt> 
instead of <tt>SmartDispatcherController</tt>. 
The <tt>ARSmartDispatcherController</tt> offers 
a <tt>CustomBindObject</tt> method that is ActiveRecord-aware.
</p><a name="ARDataBindAttribute"></a>
  <h1>ARDataBindAttribute and ARDataBinder class</h1>
<p>
So imagine that you are creating a CRUD page for a 
<tt>Customer</tt> object. Creation is really simple, 
and the <tt>DataBindAttribute</tt> attribute is enough:
</p>    <pre class="csharpcode">

<span class="kwrd">public</span> <span class="kwrd">class</span> CustomerController : ARSmartDispatcherController 
{
    <span class="kwrd">public</span> <span class="kwrd">void</span> Index()
    {
    }

    <span class="kwrd">public</span> <span class="kwrd">void</span> New()
    { 
    }

    <span class="kwrd">public</span> <span class="kwrd">void</span> Create([DataBind(<span class="str">"customer"</span>)] Customer customer)
    { 
        <span class="kwrd">try</span>
        {
            customer.Create();

            RedirectToAction(<span class="str">"index"</span>);
        }
        <span class="kwrd">catch</span>(Exception ex)
        {
            Flash[<span class="str">"error"</span>] = ex.Message;

            RedirectToAction(<span class="str">"new"</span>, Request.Form);
        }
    }
}</pre>
  <p>
Now editing is trick. You must load 
the <tt>Customer</tt>, and populate the 
changes with the form data. Enters <tt>ARDataBindAttribute</tt>:
</p>    <pre class="csharpcode">

<span class="kwrd">public</span> <span class="kwrd">class</span> CustomerController : ARSmartDispatcherController 
{
    ...

    <span class="kwrd">public</span> <span class="kwrd">void</span> Edit(<span class="kwrd">int</span> id)
    { 
        PropertyBag.Add(<span class="str">"customer"</span>, Customer.Find(id));
    }

    <span class="kwrd">public</span> <span class="kwrd">void</span> Update([ARDataBind(<span class="str">"customer"</span>, AutoLoad=AutoLoadBehavior.Always)] Customer customer)
    { 
        <span class="kwrd">try</span>
        {
            customer.Update();

            RedirectToAction(<span class="str">"index"</span>);
        }
        <span class="kwrd">catch</span>(Exception ex)
        {
            Flash[<span class="str">"error"</span>] = ex.Message;

            RedirectToAction(<span class="str">"edit"</span>, Request.Form);
        }
    }
}</pre>
  <p>
The <tt>ARDataBindAttribute</tt> extends the <tt>DataBindAttribute</tt> 
so the <tt>Exclude</tt> and <tt>Allow</tt> properties are still there.
</p><p>
However, as you can see, we used <tt>AutoLoad=AutoLoadBehavior.Always</tt>. 
This tells the binder to collect the primary key value for 
the customer and load it, then populate the object. 
So all you have to do next is to invoke <tt>Save</tt> or <tt>Update</tt> method.
</p><a name="AutoLoad"></a>
  <h1>The AutoLoad property</h1>
<p>
	It is very important that you know what the AutoLoad property means
	and the behavior it governs.
	</p><p><table class="commontable" ><tr><th>Enum field</th><th>Description</th></tr><tr><td><tt>Never</tt></td><td> Means that no autoload should be performed on the target
		type or on nested types.</td></tr><tr><td><tt>Always</tt></td><td> Means that autoload should be used for the target type
		and the nested types (if present). This demands that
		the primary key be present on the http request for the root type and nested.</td></tr><tr><td><tt>OnlyNested</tt></td><td> Does not load the root type, but loads nested types
		if the primary key is present. If not present, sets <c>null</c> on nested type.
		This is useful for insertions.</td></tr><tr><td><tt>NewInstanceIfInvalidKey</tt></td><td> Means that we should autoload, but if the key is 
		invalid, like <c>null</c>, 0 or an empty string, then just
		create a new instance of the target type.</td></tr><tr><td><tt>NullIfInvalidKey</tt></td><td> Means that we should autoload, but if the key is 
		invalid, like <c>null</c>, 0 or an empty string, then just
		set <c>null</c> on the nested type.</td></tr></table></p><a name="DataBindIssues"></a>
  <h1>ActiveRecord DataBinding Issues</h1>
<p>
	The combination of databinding and ActiveRecord opens the possibility for 
	an error that is most often hit by unexperienced users, especially when 
	using the recommended <a href="http://using.castleproject.org/display/AR/Enable+Session+per+Request" >Session Per Request</a> configuration for ActiveRecord. 
	Consider the code from above: 
	</p>    <pre class="csharpcode">

<span class="kwrd">public</span> <span class="kwrd">void</span> Update([ARDataBind(<span class="str">"customer"</span>, AutoLoad=AutoLoadBehavior.Always)] Customer customer)
{ 
    <span class="kwrd">try</span>
    {
        customer.Update();

        RedirectToAction(<span class="str">"index"</span>);
    }
    <span class="kwrd">catch</span>(Exception ex)
    {
        Flash[<span class="str">"error"</span>] = ex.Message;

        RedirectToAction(<span class="str">"edit"</span>, Request.Form);
    }
}    
      </pre>
  <p>
  	Now, what happens if there is an exception? The exception is caught as 
  	intended and the error message added to the Flash container. But actually,
  	you will get an ASP.NET errorpage nonetheless. The reason for this 
  	behaviour is simple once you know how the request is processed in the 
  	controller:
 		<ol><li>An ActiveRecord SessionScope is created in <tt>OnBeginRequest()</tt></li><li>The customer object will be looked up from database by its primary key.</li><li>The properties of the customer object are updated through databinding.</li><li><tt>customer.Update()</tt> is called and throws an exception.</li><li>The catch block executes.</li><li>
 			The ActiveRecord SessionScope is disposed in <tt>OnEndRequest()</tt>:
	  		<ol><li>NHibernate checks whether there are pending changes.</li><li>
  					The customer object is marked dirty, because its property
  					values have been changed during databinding.
  				</li><li>
  					NHibernate flushes the session. During the flush, the changes of
  					customer object are written back to the database.
  				</li><li>An unhandled exception occurs.</li></ol></li><li>The exception cannot be handled in your controller and an errorpage is shown.</li></ol></p>  <div class="note">
<div class="notetopbg">
<div class="noteborderleft">
<div class="noteborderright">
<div class="notetopleft">
<div class="notetopright">
<div class="notebottomleft">
<div class="notebottomright">
<div class="boxtitle">Quick Note</div>
<div class="innercontent">
<p>
		The same issue appears when using ActiveRecord's validation support. 
		Behaviour and reasons are identical in that case: The object is not saved 
		but changed by the DataBinder and will be saved by NHibernate when the
		session is disposed.
		</p>
</div></div></div></div></div></div></div></div></div>
<p>
  	So, now that the problem is known, how can it be handled? There are plenty possible 
  	solutions for this, depending on the user's needs:
	  	<ol><li>Make the session readonly and always flush it explicitly.</li><li>Remove the offending object from the session.</li><li>Create a <tt>TransactionScope</tt> and roll it back.</li><li>Use the <tt>Validate</tt> option of <tt>ARDataBind</tt></li></ol></p><a name="readonlysession"></a>
  <h2>Using a Read-Only-Session</h2>
<p>
		If you change the <tt>SessionScope</tt> to not automatically flush,
		changes are not flushed on disposal of the scope. You can setup the
		scope as shown below (based on <a href="http://using.castleproject.org/display/AR/Enable+Session+per+Request" >this article</a>):
		</p>    <pre class="csharpcode">

<span class="rem">// GlobalApplication.cs</span>
<span class="kwrd">public</span> <span class="kwrd">void</span> OnBeginRequest(<span class="kwrd">object</span> sender, EventArgs e)
{
    HttpContext.Current.Items.Add(<span class="str">"nh.sessionscope"</span>, <span class="kwrd">new</span> SessionScope(FlushAction.Never);
}        
        </pre>
  <p>
		Doing so requires you to flush your sesssion manually in every
		controller that changes existing objects or introduces new objects to 
		the database. There are two possibilities to get the session object to flush:
		</p>    <pre class="csharpcode">

<span class="rem">// Use this when the session was added to the HttpContext in OnBeginRequest</span>
((SessionScope)Context.Items[<span class="str">"nh.sessionscope"</span>]).Flush();
        </pre>
      <pre class="csharpcode">

<span class="rem">// Gets the session, if it is not stored in a known place.</span>
ActiveRecordMediator
    .GetSessionFactoryHolder()
    .CreateSession(<span class="kwrd">typeof</span>(Customer))
    .Flush();
        </pre>
  <a name="evicting"></a>
  <h2>Removing Invalid Objects From Session</h2>
<p>
		Another possibility is to keep the default behaviour and only assure 
		that invalid objects are not flushed on disposal of the session. This
		strategy is recommended when there are objects that need to be saved to
		the database even when one object is invalid and must not be stored.
		</p><p>
		You might also want to use this strategy when you are using Windsor
		integration and the ActiveRecordIntegration facility, because in this
		case you cannot change the session to be read-only within your code.
		</p><p>To remove the conflicting object from the <tt>SessionScope</tt>, you
		must <tt>Evict</tt> it:</p>    <pre class="csharpcode">

ActiveRecordMediator
    .GetSessionFactoryHolder()
    .CreateSession(<span class="kwrd">typeof</span>(Customer))
    .Evict(customer);
        </pre>
  <p>
		By using the <tt>ActiveRecordMediator</tt>, you will get access to the
		session regardless where it as been originally created.
		</p><a name="transactionrollback"></a>
  <h2>Using a TransactionScope</h2>
<p>
		Another method is to wrap the validation in a transaction. If the 
		validation fails, the transaction must be rolled back:
		</p>    <pre class="csharpcode">

<span class="kwrd">using</span> (TransactionScope tx = <span class="kwrd">new</span> TransactionScope())
{
    <span class="kwrd">try</span>
    {
        customer.Update();
        RedirectToAction(<span class="str">"index"</span>);
    }
    <span class="kwrd">catch</span>(Exception ex)
    {
        Flash[<span class="str">"error"</span>] = ex.Message;
        tx.Rollback();
        RedirectToAction(<span class="str">"edit"</span>, Request.Form);
    }
}
        </pre>
  <p>
		You might wonder how this works because I wrote above that the 
		DataBinder makes the offending changes outside of the
		<tt>TransactionScope</tt>. The answer is that TransactionScopes can be
		nested and that there is an implicit transaction started during the
		creation of the <tt>SessionScope</tt>. The rollback is then propagated
		to that transaction and all changes are discarded.
		</p><p>
		However, that means that if you have other objects that must be saved,
		you should instead evict the invalid object as descibed <a href="#evicting" >above</a></p><a name="validation"></a>
  <h2>Use Validation during DataBinding</h2>
<p>
  		The most elegant method to circumvent such problems is the use of the
  		Castle Validation component. By setting the parameter <tt>Validate</tt>
  		of the <tt>ARDataBind</tt>-attribute to <tt>true</tt>, MonoRail performs
  		validation of the input data before changing the properties based on the
  		<tt>Validate<i>XXX</i></tt>-Attributes of the ActiveRecord model classes.
  		</p><p>
  		The drawback is that invalid data is completely discarded and will not
  		redisplayed to the client by <tt>FormHelper</tt>. In order to access the
  		data, <tt>Request.Params</tt> must be used.
  		</p>    <pre class="csharpcode">

<span class="kwrd">public</span> <span class="kwrd">void</span> Update(
    [ARDataBind(<span class="str">"customer"</span>, 
        AutoLoadBehavior.NewRootInstanceIfInvalidKey, 
        Validate = <span class="kwrd">true</span>)] Customer customer)
{
    <span class="kwrd">if</span> (ValidationSummaryPerInstance[info].ErrorsCount &gt; 0)
    {
        <span class="kwrd">string</span> msg = <span class="str">"Please correct errors:"</span>;
        <span class="kwrd">foreach</span> (<span class="kwrd">string</span> p <span class="kwrd">in</span> ValidationSummaryPerInstance[customer].InvalidProperties)
        {
            msg += <span class="str">"&lt;p&gt;"</span> + p + <span class="str">":&lt;/p&gt;"</span>;
            <span class="kwrd">foreach</span> (<span class="kwrd">string</span> m <span class="kwrd">in</span> ValidationSummaryPerInstance[customer].GetErrorsForProperty(p))
            {
                msg += <span class="kwrd">string</span>.Format(<span class="str">"&lt;p&gt;{0}&lt;/p&gt;"</span>, m);
            }
        }
        Flash[<span class="str">"message"</span>] = msg;
        Flash[<span class="str">"customer"</span>] = customer;
        RedirectToReferrer();
        <span class="kwrd">return</span>;
    }
    <span class="rem">// "Normal" application flow</span>
    <span class="rem">// ...</span>
}
        </pre>
  <a name="ARFetch"></a>
  <h1>ARFetchAttribute</h1>
<p>
The <tt>ARFetchAttribute</tt> is a simpler version of <tt>ARDataBinder</tt>. 
It is in charge of loading the instance from the database and nothing more. 
</p>    <pre class="csharpcode">

<span class="kwrd">public</span> <span class="kwrd">class</span> CustomerController : ARSmartDispatcherController 
{
    ...

    <span class="kwrd">public</span> <span class="kwrd">void</span> SetPassword([ARFetch(<span class="str">"customer.id"</span>)] Customer customer, String newPassword)
    { 
        <span class="kwrd">try</span>
        {
            customer.Password = newPassword;
            customer.Save();

            RedirectToAction(<span class="str">"index"</span>);
        }
        <span class="kwrd">catch</span>(Exception ex)
        {
            Flash[<span class="str">"error"</span>] = ex.Message;

            RedirectToAction(<span class="str">"changepassword"</span>, Request.Form);
        }
    }
}</pre>
  <p>
The optional parameter passed to <tt>ARFetch</tt> 
tells it which form field has the primary key value. 
If you don't specify it, it will use the parameter 
name (for the example above it would be <tt>customer</tt>)
</p><p>
You can also specify <tt>Required=true</tt> which will 
force it to throw an exception if the record is not found:
</p>    <pre class="csharpcode">

<span class="kwrd">public</span> <span class="kwrd">class</span> CustomerController : ARSmartDispatcherController 
{
    ...

    <span class="kwrd">public</span> <span class="kwrd">void</span> SetPassword([ARFetch(<span class="str">"customer.id"</span>, Required=<span class="kwrd">true</span>)] Customer customer, String newPassword)
    { 
        ...
    }
}</pre>
  <p>
And <tt>Create=true</tt>, which will create a 
new object if the primary key form field is empty:
</p>    <pre class="csharpcode">

<span class="kwrd">public</span> <span class="kwrd">class</span> CustomerController : ARSmartDispatcherController 
{
    ...

    <span class="kwrd">public</span> <span class="kwrd">void</span> CreateOrModifyCustomer([ARFetch(<span class="str">"customer.id"</span>, Create=<span class="kwrd">true</span>)] Customer customer, String name, ...)
    { 
        customer.Name = name;
        customer.Save();
    }
}</pre>
  		<!-- end content -->
		
	<div id="footer">
<script type="text/javascript"><!--
google_ad_client = "pub-2091974950947714";
/* 728x90, created 2/13/08 */
google_ad_slot = "5378217716";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
	
	<br/>
	Found an error? Something inaccurate? 
	<a href="../../../../community/getinvolved.html">Help us improve the documentation</a> <br/>
	Generated by <a href="../../../../others/anakia/index.html">Castle Anakia</a>. 
	
	<p>&nbsp;</p>
	
	<p>
	Sponsored by <img src="../../../../images/logothumb.gif" /> <a href="http://www.castlestronghold.com">Castle Stronghold</a>.
	</p>
	
	</div>

	<!-- Search Google -->
<center>
<FORM method=GET action="http://www.google.com/custom">
<TABLE bgcolor="#FFFFFF" cellspacing="4" border="0" style="border: solid 1px gray;" align="center">
<tr valign=top><td>
<A HREF="http://www.google.com/search">
<IMG SRC="http://www.google.com/logos/Logo_40wht.gif" border=0 ALT=Google align=middle></A>
</td>
<td>
<INPUT TYPE=text name=q size=31 maxlength=255 value="">
<INPUT type=submit name=sa VALUE="Google Search">
<INPUT type=hidden name=cof VALUE="S:http://www.castlestronghold.com;GL:1;VLC:#373737;AH:center;LH:63;LC:#0A50A1;GFNT:#5B5B5B;L:http://www.castleproject.org/images/castle-logo.gif;ALC:#0A50A1;BIMG:http://www.castleproject.org/images/bg.png;LW:280;T:#5B5B5B;AWFID:3d565acacdd9f388;">
<input type=hidden name=domains value="castleproject.org"><br><input type=radio name=sitesearch value=""> Search WWW <input type=radio name=sitesearch value="castleproject.org" checked> Search castleproject.org
</td></tr></TABLE>
</FORM>
<!-- Search Google -->
</center>
	&nbsp;
	<br/>

		</div> <!-- end of content -->
  </div><!-- end of page -->
  


	<script type="text/javascript">_uacct = "UA-1190612-1";urchinTracker();</script>
	<script type="text/javascript">
		var uservoiceJsHost = ("https:" == document.location.protocol) ? "https://uservoice.com" : "http://cdn.uservoice.com";
		document.write(unescape("%3Cscript src='" + uservoiceJsHost + "/javascripts/widgets/tab.js' type='text/javascript'%3E%3C/script%3E"))
	</script>
	<script type="text/javascript">
		UserVoice.Popin.setup({ 
			key: 'castle',
			alignment: 'right',
			host: 'castle.uservoice.com', 
			forum: 'general', 
			lang: 'en'
		})
	</script>
	</body>
</html>
