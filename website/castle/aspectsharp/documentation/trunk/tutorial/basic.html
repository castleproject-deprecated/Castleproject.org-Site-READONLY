<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">









<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
		<title>Tutorial :: Castle Project</title>
		<link rel="stylesheet" href="../../../../base.css" />
		<link rel="stylesheet" href="../../../../front.css" />
		<link rel="stylesheet" href="../../../../elem.css" />
		<link rel="stylesheet" href="../../../../csharp.css" />
		<link rel="stylesheet" href="../../../../TAB_styles.css" />
		<script type="text/javascript" src="../../../../mktree.js"></script>
		<script type="text/javascript" src="../../../../TAB_Function_Lib.js"></script>
		<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script>
	</head>

	<body>
<div id="topheader">
  <div id="maintitle">
	<h1> <a href="../../../../index.html" title="Castle Project Home" accesskey="1">Home</a> </h1>
	<h2> <a href="http://www.castlestronghold.com" title="Castle Stronghold: support, consulting and development">Castle Stronghold</a> </h2>
  </div>
  <div id="mainbar">
	<ul id="toplinks">
		<li>&nbsp;</li>
		<li><a style="_width: 70px;" href="../../../../index.html">Home</a></li>
		<li><a style="_width: 70px;" href="../../../../castle/download.html">Download</a></li>
		<li><a style="_width: 110px;" href="http://api.castleproject.org">API Doc</a></li>
		<li><a style="_width: 50px;" href="http://using.castleproject.org">Using</a></li>
		<li><a style="_width: 60px;" href="../../../../community/forum.html">Forum</a></li>
		<li><a style="_width: 120px;" href="../../../../jira.html">Jira/Issue tracker</a></li>
		<li><a style="_width: 110px;" href="http://builds.castleproject.org">Builds</a></li>
	</ul>
  </div>
</div>



<div id="coolpage">

	<div id="sidebar" >
		
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../aspectsharp/index.html">Aspect#</a>
</span>
  <ul>
<li>
<a href="./../../../../aspectsharp/gettingstarted/index.html">Getting started</a>
</li>
<li>
<a href="./../../../../aspectsharp/faq.html">FAQ</a>
</li>
<li>
<a href="./../../../../aspectsharp/recipes/index.html">Recipes</a>
</li>
<li>
<a href="./../../../../aspectsharp/externalarticles.html">External Articles</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="darkmenu">
    <div class="darkmenucontent">
<span class="menutitle">
Navigation
</span>
  <ul>
<li>
<a href="./../../../../aspectsharp/index.html">Back to Aspect#</a>
</li>
<li>
<a href="./../../../../index.html">Back to Main Page</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
	<br/>
	
	</div>
		
	<div id="content">
	
		<div class="callout-pic">

<!-- Begin Table of contents -->
<div id="toc">
<h2>Table of contents</h2>
<ul>
<li class='toclevel-1'><a href="#situation"><span class="tocnumber">1</span> <span class="toctext">An hypothetical situation - not so much</span></a>
</li>
<li class='toclevel-1'><a href="#solutions"><span class="tocnumber">2</span> <span class="toctext">The available solutions</span></a>
</li>
<li class='toclevel-1'><a href="#mixinsolution"><span class="tocnumber">3</span> <span class="toctext">The Mixin solution</span></a>
</li>
<li class='toclevel-1'><a href="#aspectconfiguration"><span class="tocnumber">4</span> <span class="toctext">Describing your aspect configuration</span></a>
</li>
<li class='toclevel-1'><a href="#aspectconfiguration"><span class="tocnumber">5</span> <span class="toctext">Intercepting invocations</span></a>
</li>
<li class='toclevel-1'><a href="#aspectconfiguration"><span class="tocnumber">6</span> <span class="toctext">Conclusion</span></a>
</li>
<li class='toclevel-1'><a href="#aspectconfiguration"><span class="tocnumber">7</span> <span class="toctext">Where to go from here?</span></a>
</li>
</ul>
</div>
<!-- End Table of contents -->
		</div>

		<h1 class="firstHeading">
		    Tutorial
		</h1> 
	
<div class="breadcrumbs">
&raquo;
	<a href="./../../../../index.html">Home</a> 
&raquo;
	<a href="./../../../../aspectsharp/index.html">Aspect#</a> 
&raquo;
	<a href="./../../../../aspectsharp/documentation/index.html">Documentation</a> 
&raquo;
	<a href="./../../../../aspectsharp/documentation/trunk/index.html">MonoRail RC2 Documentation</a> 
&raquo;
	<a href="./../../../../aspectsharp/documentation/trunk/tutorial/index.html">Tutorial</a> 
&raquo;
<u>Tutorial</u>
</div>

		<!-- start content -->
<p>
So you think your project might benefit from some AOP approach. This tutorial introduces the Aspect# approach for AOP. Basically we are going to talk about the Aspect# built-in language for declaring aspects, mixins and interceptors.
<br></br>
The final sourcecode for this tutorial is included in the Aspect# distribution under the AspectSharpExample directory. It can be browsed in SVN here: http://svn.castleproject.org/svn/castle/trunk/AspectSharp/AspectSharp.Example/
<br></br>
The application starts in: AspectSharpExample/Application.cs 
</p><a name="situation"></a>
  <h1>An hypothetical situation - not so much</h1>
<p>To make things more interesting, lets suppose you're working on a specific application. You're creating a revolutionary Content Management System, and you probably end up with a big although nice and simple object model. The most important components implement IContentProvider and IView. IContentProvider is obviously responsible for gathering content from some source like database, Xml, RSS,  Excel files and IView is responsible for displaying it in a specific way for a specific channel. </p><p>Everything is fine and your almost done with your four thousand ContentProviders and Views that cover all existing communications channels available in the world today. Suddenly, the sales guy - always blame the sales guy - comes, with from his standpoint, an non-important requirement. He needs security checking for providers and views, and he already sold it as done for an important customer, lets say the BBC. Your company's future depends on having it completed by the end of the day!</p><a name="solutions"></a>
  <h1>The available solutions</h1>
<p>You need to expose your objects as a securable resource for your security framework. To ease the burden of having to change every single ContentProvider and View  you think about a few possibilities:</p><ul><li>Create a property on IContentProvider and on IView exposing the IResource information.</li><li>Create an 'IResourceable' and making IContentProvider and IView extend from it.. Then modify its base classes, although you're not sure whether such a base class exists.</li><li>You're on the ninth floor, so jumping out the window could solve things for a while...</li></ul><p>The problem with these possibilities is that they all will bungle your nice and clean object model. In your conception security doesn't have anything to do with content providers and views, but for some of them it makes sense. So, for those that make sense you'd like to introduce the ISecurityResource interface and implementation.<br></br>
Well, c'mon! You only have a few hours, start to modify those components now! Not so fast, let's use AOP for it.</p><a name="mixinsolution"></a>
  <h1>The Mixin solution</h1>
<p>Nowadays, many AOP frameworks implement the mixin functionality. Though it's not really an AOP concept, while this is introducing something to a class of a set of classes, then it's all right, we can call it AOP.<br></br>
The idea here is to make all ContentProvider in a given namespace implement the ISecurityResource interface with a valid implementation, of course. We can do this like this:</p>    <pre class="csharpcode">

 <span class="kwrd">public</span> <span class="kwrd">class</span> SecurityResourceImpl : ISecurityResource
 {
       <span class="kwrd">public</span> SecurityResourceImpl()
       {
       }
 
       <span class="kwrd">public</span> String ResourceName
       {
             get { <span class="kwrd">return</span> <span class="str">"Content"</span>; }
       } 
 }
</pre>
  <p>Now we need to apply this to a particular class or to a set of classes in our project.</p><a name="aspectconfiguration"></a>
  <h1>Describing your aspect configuration</h1>
<p>We use a built-in language (Ruby like) to configure the aspects. You can keep this configuration in a external file, in your code (not recommended) or in the .config file associated with your application.</p>  <pre class="commonpre">
 import YourCompany.CMS.ContentProviders in YourCompanyAssembly
 
 aspect SecurityAspect for RSSContentProvider
 
     include Mixins.SecurityResourceImpl in MyMixinsAssembly
 
 end
</pre>
<p>This aspect targets the RSSContentProvider class and includes the SecurityResourceImpl class. What does it mean? Well, when you get your RSSContentProvider instance it will have the ISecurityResource interface implemented by the SecurityResourceImpl. </p><p>You mixed them, hence Mixin :-)</p><p>Instead of targeting a specific class, you can targets a set of classes like all the classes in the given namespace:</p>  <pre class="commonpre">
 import YourCompany.CMS.ContentProviders in YourCompanyAssembly
 
 aspect SecurityAspect for [ YourCompany.CMS.ContentProviders ]
 
   include Mixins.SecurityResourceImpl in MyMixinsAssembly
 
 end
</pre>
<p>Now we need to create an Aspect# engine to do this magic:</p>    <pre class="csharpcode">

 StreamReader reader = <span class="kwrd">new</span> StreamReader( configfile );
 AspectEngineBuilder builder = <span class="kwrd">new</span> AspectLanguageEngineBuilder(reader);
 
 AspectEngine engine = builder.Build();
 RSSContentProvider provider = engine.Wrap( <span class="kwrd">new</span> RSSContentProvider() );
</pre>
  <tt>But wait a minute! This is a very naive implementation of ISecurityResource. What if 
the security resource needs to access something from the content provider or the view? Gotcha</tt><p>Not really. If your mixin needs to access the underlying component it must implement the IProxyAware interface:</p>    <pre class="csharpcode">

 <span class="kwrd">public</span> <span class="kwrd">class</span> SecurityResourceImpl : ISecurityResource, IProxyAware
 {
        <span class="kwrd">private</span> String _name;
 
        <span class="kwrd">public</span> SecurityResourceImpl()  
        {  
        }
 
        <span class="kwrd">public</span> <span class="kwrd">void</span> SetProxy(<span class="kwrd">object</span> proxy)  
        {  
                <span class="kwrd">if</span> (proxy <span class="kwrd">is</span> IContentProvider)  
                {  
                        Name = (proxy <span class="kwrd">as</span> IContentProvider).Name;  
                }  
                <span class="kwrd">else</span> <span class="kwrd">if</span> (proxy <span class="kwrd">is</span> IView)  
                {  
                        Name = (proxy <span class="kwrd">as</span> IView).Name;  
                }  
        }
 
        <span class="kwrd">public</span> String Name  
        {  
                get { <span class="kwrd">return</span> _name; }  
                set { _name = <span class="kwrd">value</span>; }  
        }
 
        <span class="kwrd">public</span> String ResourceName  
        {  
                get { <span class="kwrd">return</span> Name; }  
        }  
  }
</pre>
  <p>Your mixin doesn't need to implement or expose anything, but if it does implement some interface then the Wrap'ed instance will expose them and forward the calls. Your mixin must have a default constructor, though.</p><a name="aspectconfiguration"></a>
  <h1>Intercepting invocations</h1>
<p>The most sensible method in IContentProvider is the RetrieveContent method, so for every content provider, which implements the ISecurityResource interface, it is a good idea to invoke the ISecurityResource.Demand() to fire all security checks.</p><p>Time to change the content provider code... well wait! Maybe Aspect# can help us implementing this check for us.</p><p>You're right! All we need to do is intercept the methods we want and perform the check.
First we need a pointcut which will select the methods or properties. Within a pointcut you can
add advices that will perform some action on the resulting Joinpoints.</p><p>What a lot of new words! Ok, so lets get things clear:
<ul><li>Pointcut: selects methods and|or properties within a type (including the mixins)</li><li>Joinpoints: method or properties that matched the pointcut</li><li>Advice: some code that will be performed before|after the joinpoint.</li></ul></p><p>Aspect# supports only one type of advice: MethodInterceptor. MethodInterceptors allow you to execute some code before and|or after a target method. Lets do it: </p>  <pre class="commonpre">
 import YourCompany.CMS.ContentProviders in YourCompanyAssembly
 import YourCompany.CMS.Aop.Interceptors
 
 aspect SecurityAspect for RSSContentProvider
      include Mixins.SecurityResourceImpl in MyMixinsAssembly
 
      pointcut method(* RetrieveContent(*))
            advice(SecurityCheckInterceptor)
      end
 end
</pre>
<p>Our pointcut states 'I don't care about the return value, just match all methods named RetrieveContent and I don't care about its arguments either'. So we don't have to worry about other methods being checked unnecessarily.</p><p>And now for something completely different: our MethodInterceptor implementation:</p>    <pre class="csharpcode">

 <span class="kwrd">public</span> <span class="kwrd">class</span> SecurityCheckInterceptor : IMethodInterceptor
 {
    <span class="kwrd">public</span> <span class="kwrd">object</span> Invoke(IMethodInvocation invocation)
    {
        ISecurityResource target = invocation.GetThis() <span class="kwrd">as</span> ISecurityResource;
        target.Demand(); <span class="rem">// Can throw a SecurityException</span>
 
        <span class="kwrd">return</span> invocation.Proceed(); <span class="rem">// All right, get on with it</span>
    }
 }
</pre>
  <p>This implementation is pretty straightforward. Please note that the GetThis returns the proxy, so if you, for instance, invoke RetrieveContent within the interceptor then your interceptor will be called again and you can end up with a stack overflow.</p><a name="aspectconfiguration"></a>
  <h1>Conclusion</h1>
<p>Its easy to solve several common problems in an application with AOP. Aspect#<br></br>
tries to ease the burden of using AOP and do it propertly. Now our two minute tutorial is over. If you're complaining that you spent more than two minutes reading this, well.. I'm a slow reader myself :-)</p><a name="aspectconfiguration"></a>
  <h1>Where to go from here?</h1>
<ul><li>[[AspectSharp Language Documentation]]</li><li>[[AspectSharp Reference Documentation]]</li></ul>		<!-- end content -->

<script type="text/javascript"><!--
google_ad_client = "pub-2091974950947714";
/* 728x90, created 2/13/08 */
google_ad_slot = "5378217716";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
		
	<div id="footer">
	Found an error? Something inaccurate? 
	<a href="../../../../community/getinvolved.html">Help us improve the documentation</a> <br/>
	Generated by <a href="../../../../others/anakia/index.html">Castle Anakia</a>. 
	
	<p>&nbsp;</p>
	
	<p>
	Sponsored by <img src="../../../../images/logothumb.gif" /> <a href="http://www.castlestronghold.com">Castle Stronghold</a>.
	</p>
	
	</div>

	<!-- Search Google -->
<center>
<FORM method=GET action="http://www.google.com/custom">
<TABLE bgcolor="#FFFFFF" cellspacing="4" border="0" style="border: solid 1px gray;" align="center">
<tr valign=top><td>
<A HREF="http://www.google.com/search">
<IMG SRC="http://www.google.com/logos/Logo_40wht.gif" border=0 ALT=Google align=middle></A>
</td>
<td>
<INPUT TYPE=text name=q size=31 maxlength=255 value="">
<INPUT type=submit name=sa VALUE="Google Search">
<INPUT type=hidden name=cof VALUE="S:http://www.castlestronghold.com;GL:1;VLC:#373737;AH:center;LH:63;LC:#0A50A1;GFNT:#5B5B5B;L:http://www.castleproject.org/images/castle-logo.gif;ALC:#0A50A1;BIMG:http://www.castleproject.org/images/bg.png;LW:280;T:#5B5B5B;AWFID:3d565acacdd9f388;">
<input type=hidden name=domains value="castleproject.org"><br><input type=radio name=sitesearch value=""> Search WWW <input type=radio name=sitesearch value="castleproject.org" checked> Search castleproject.org
</td></tr></TABLE>
</FORM>
<!-- Search Google -->
</center>
	&nbsp;
	<br/>

		</div> <!-- end of content -->
  </div><!-- end of page -->
  


	<script type="text/javascript">_uacct = "UA-1190612-1";urchinTracker();</script>
	</body>
</html>
