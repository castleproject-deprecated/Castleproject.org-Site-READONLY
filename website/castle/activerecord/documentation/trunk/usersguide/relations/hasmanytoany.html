<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">









<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
		<title>Any and HasManyToAny :: Castle Project</title>
		<link rel="stylesheet" href="../../../../../base.css" />
		<link rel="stylesheet" href="../../../../../front.css" />
		<link rel="stylesheet" href="../../../../../elem.css" />
		<link rel="stylesheet" href="../../../../../csharp.css" />
		<link rel="stylesheet" href="../../../../../TAB_styles.css" />
		<script type="text/javascript" src="../../../../../mktree.js"></script>
		<script type="text/javascript" src="../../../../../TAB_Function_Lib.js"></script>
	</head>

	<body>
<div id="topheader">
  <div id="maintitle">
	<h1> <a href="../../../../../index.html" title="Castle Project Home" accesskey="1">Home</a> </h1>
	<h2> <a href="http://www.castlestronghold.com" title="Castle Stronghold: support, consulting and development">Castle Stronghold</a> </h2>
  </div>
  <div id="mainbar">
	<ul id="toplinks">
		<li>&nbsp;</li>
		<li><a style="_width: 70px;" href="../../../../../index.html">Home</a></li>
		<li><a style="_width: 70px;" href="../../../../../castle/download.html">Download</a></li>
		<li><a style="_width: 50px;" href="http://wiki.castleproject.org">Wiki</a></li>
		<li><a style="_width: 60px;" href="../../../../../community/forum.html">Forum</a></li>
		<li><a style="_width: 100px;" href="../../../../../jira.html">Issue Tracker</a></li>
		<li><a style="_width: 80px;" href="../../../../../irc.html">IRC Channel</a></li>
		<li><a style="_width: 80px;" href="http://builds.castleproject.org">Build Server</a></li>
	</ul>
  </div>
</div>



<div id="coolpage">

	<div id="sidebar" >
		
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../../activerecord/index.html">ActiveRecord</a>
</span>
  <ul>
<li>
<a href="./../../../../../activerecord/gettingstarted/index.html">Getting started</a>
</li>
<li>
<a href="./../../../../../activerecord/faq.html">FAQ</a>
</li>
<li>
<a href="./../../../../../activerecord/recipes/index.html">Recipes</a>
</li>
<li>
<a href="./../../../../../activerecord/externalarticles.html">External Articles</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../../activerecord/documentation/trunk/index.html">Documentation</a>
</span>
  <ul>
<li>
<a href="./../../../../../activerecord/documentation/trunk/releasenotes/index.html">Release notes</a>
</li>
<li>
<a href="./../../../../../activerecord/documentation/trunk/manual/index.html">Reference Manual</a>
</li>
<li>
<a href="./../../../../../activerecord/documentation/trunk/usersguide/index.html">User's Guide</a>
</li>
<li>
<a href="./../../../../../activerecord/documentation/trunk/advanced/index.html">Advanced usage</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="darkmenu">
    <div class="darkmenucontent">
<span class="menutitle">
Navigation
</span>
  <ul>
<li>
<a href="./../../../../../index.html">Back to Main Page</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
	<br/>
	
	</div>
		
	<div id="content">
	
		<div class="callout-pic">

<!-- Begin Table of contents -->
<div id="toc">
<h2>Table of contents</h2>
<ul>
<li class='toclevel-1'><a href="#any"><span class="tocnumber">1</span> <span class="toctext">Using Any</span></a>
</li>
<li class='toclevel-1'><a href="#hasmanytoany"><span class="tocnumber">2</span> <span class="toctext">Using HasManyToAny</span></a>
</li>
</ul>
</div>
<!-- End Table of contents -->
		</div>

		<h1 class="firstHeading">
		    Any and HasManyToAny
		</h1> 
	
<div class="breadcrumbs">
&raquo;
	<a href="./../../../../../index.html">Home</a> 
&raquo;
	<a href="./../../../../../activerecord/index.html">ActiveRecord</a> 
&raquo;
	<a href="./../../../../../activerecord/documentation/index.html">Documentation</a> 
&raquo;
	<a href="./../../../../../activerecord/documentation/trunk/index.html">ActiveRecord trunk Documentation</a> 
&raquo;
	<a href="./../../../../../activerecord/documentation/trunk/usersguide/index.html">User's Guide</a> 
&raquo;
	<a href="./../../../../../activerecord/documentation/trunk/usersguide/relations/index.html">Relations</a> 
&raquo;
<u>Any and HasManyToAny</u>
</div>

		<!-- start content -->
<p>
There are certain cases when you need to make an association from an entity to a range of possible objects that doesn't necessarily share a common base class.
</p>  <div class="warning">
<div class="warningtopbg">
<div class="warningborderleft">
<div class="warningborderright">
<div class="warningtopleft">
<div class="warningtopright">
<div class="warningbottomleft">
<div class="warningbottomright">
	<div class="boxtitle">Warning</div>
<div class="innercontent">
<p>
This is a fairly advanced scenario. Try to find a simpler solution if you can.
</p>
</div></div></div></div></div></div></div></div></div>
<a name="any"></a>
  <h1>Using Any</h1>
<p>
A simple example may be a payment method in an <tt>Order</tt> class, 
where the choices are either a bank account or a credit card, like this:
</p>    <pre class="csharpcode">

<span class="kwrd">using</span> Castle.ActiveRecord;

[ActiveRecord(<span class="str">"CreditCards"</span>)]
<span class="kwrd">public</span> <span class="kwrd">class</span> CreditCard : ActiveRecordBase, IPaymentMethod
{ ... }

[ActiveRecord(<span class="str">"BankAccounts"</span>)]
<span class="kwrd">public</span> <span class="kwrd">class</span> BankAccount : ActiveRecordBase, IPaymentMethod
{ ... }</pre>
  <p>
A possible <tt>Order</tt> class does not know in advance the payment map, or how to map them.
They are not part of any hierarchy (either in the object model or an ActiveRecord one).
The solution is to map them to this schema:
</p>    <pre class="csharpcode">

<span class="kwrd">CREATE</span> <span class="kwrd">TABLE</span> Orders
(
  [Id] [<span class="kwrd">int</span>] <span class="kwrd">not</span> <span class="kwrd">null</span> <span class="kwrd">identity</span>(1,1),
  ...
  [Billing_Details_Id] [<span class="kwrd">int</span>] <span class="kwrd">not</span> <span class="kwrd">null</span>, 
  [Billing_Details_Type] [nvarchar] <span class="kwrd">not</span> <span class="kwrd">null</span>
)</pre>
  <p>
Together <tt>BillingDetailsId</tt> and <tt>BillingDetailsType</tt>
points to the correct account or credit card that should pay for the order. Here is the attributes declarations. Note that unlike most other attributes, here you need to specify a few properties.
They cannot be infered.
</p>    <pre class="csharpcode">

[Any(<span class="kwrd">typeof</span>(<span class="kwrd">int</span>), MetaType=<span class="kwrd">typeof</span>(<span class="kwrd">string</span>),
    TypeColumn=<span class="str">"Billing_Details_Type"</span>,
    IdColumn=<span class="str">"Billing_Details_Id"</span>,
    Cascade=CascadeEnum.SaveUpdate)]
[Any.MetaValue(<span class="str">"CREDIT_CARD"</span>, <span class="kwrd">typeof</span>(CreditCard))]
[Any.MetaValue(<span class="str">"BANK_ACCOUNT"</span>, <span class="kwrd">typeof</span>(BankAccount))]
<span class="kwrd">public</span> IPaymentMethod PaymentMethod 
{ 
    get { ... } 
    set { ... } 
}</pre>
  <p>
The first parameter is the type of the <tt>Id</tt> column 
(in this case <tt>BillingDetailsId</tt>), 
the second is the <tt>MetaType</tt> definition, which in this 
case mean the type of the the field that defines the type of the id.
</p><p>
Next we have the <tt>TypeColumn</tt> and <tt>IdColumn</tt>, 
which match <tt>Billing_Details_Type</tt> and <tt>Billing_Details_Id</tt>.
</p><p>
The interesting part is the <tt>Any.MetaValue</tt> attribute. 
Here, we define that when the value in the <tt>Billing_Details_Type</tt> 
column is <tt>"CREDIT_CARD"</tt>, the value in the <tt>Billing_Details_Id</tt> 
column is the primary key of a <tt>CreditCard</tt>, 
and when the <tt>Billing_Details_Type</tt> is <tt>BANK_ACCOUNT</tt>, 
then the value in <tt>Billing_Details_Id</tt> 
should be interpreted as the primary key of a <tt>BankAccount</tt> class.
</p>  <div class="note">
<div class="notetopbg">
<div class="noteborderleft">
<div class="noteborderright">
<div class="notetopleft">
<div class="notetopright">
<div class="notebottomleft">
<div class="notebottomright">
<div class="boxtitle">Quick Note</div>
<div class="innercontent">
<p>
The type of the property should be of a common type or interface that all the possible objects share (worst case scenario: make it of type <tt>System.Object</tt>).
</p>
</div></div></div></div></div></div></div></div></div>
<a name="hasmanytoany"></a>
  <h1>Using HasManyToAny</h1>
<p>
A natural extention of <tt>Any</tt>, the <tt>HasManyToAnyAttribute</tt> 
provides the same functionality for collections. 
Here is an example of a class that needs a set of payment methods:
</p>    <pre class="csharpcode">

[HasManyToAny(<span class="kwrd">typeof</span>(IPayment), <span class="str">"pay_id"</span>, <span class="str">"payments_table"</span>, <span class="kwrd">typeof</span>(<span class="kwrd">int</span>), 
    <span class="str">"Billing_Details_Type"</span>, <span class="str">"Billing_Details_Id"</span>, MetaType=<span class="kwrd">typeof</span>(<span class="kwrd">string</span>))]
[Any.MetaValue(<span class="str">"CREDIT_CARD"</span>, <span class="kwrd">typeof</span>(CreditCard))]
[Any.MetaValue(<span class="str">"BANK_ACCOUNT"</span>, <span class="kwrd">typeof</span>(BankAccount))]
<span class="kwrd">public</span> ISet PaymentMethod 
{ 
    get { ... } 
    set { ... } 
}
</pre>
  <p>
The parameters for HasManyToAny are (in order of apperances in the constructor):

<ul><li><tt>typeof(IPayment)</tt>: the type of the objects in this collection </li><li><tt>pay_id</tt>: the key column that maps the values in this collection to this object</li><li><tt>payment_table</tt>: the table for this collection</li><li><tt>typeof(int)</tt>: the type of the id column - identical to the first parameter of <tt>Any</tt></li><li><tt>Billing_Details_Type</tt>: identical in function to the <tt>Billing_Details_Type</tt> mentioned above</li><li><tt>Billing_Details_Id</tt>: identical to the <tt>Billing_Details_Id</tt> mentioned above</li><li><tt>MetaType=typeof(string)</tt>: the type of the type column / identical to the 
one described above</li></ul></p><p>
More information on the attribute can be found 
at <a href="../../manual/attributes.html" >Attributes</a> article.
</p>		<!-- end content -->
		
	<div id="footer">
	Found an error? Something inaccurate? 
	<a href="../../../../../community/getinvolved.html">Help us improve the documentation</a> <br/>
	Generated by <a href="../../../../../others/anakia/index.html">Castle Anakia</a>. 
	</div>

	&nbsp;
	<br/>

		</div> <!-- end of content -->
  </div><!-- end of page -->
  


	</body>
</html>
