<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">









<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
		<title>Understanding Scopes :: Castle Project</title>
		<link rel="stylesheet" href="../../../../base.css" />
		<link rel="stylesheet" href="../../../../front.css" />
		<link rel="stylesheet" href="../../../../elem.css" />
		<link rel="stylesheet" href="../../../../csharp.css" />
		<link rel="stylesheet" href="../../../../TAB_styles.css" />
		<script type="text/javascript" src="../../../../mktree.js"></script>
		<script type="text/javascript" src="../../../../TAB_Function_Lib.js"></script>
		<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script>
	</head>

	<body>
<div id="topheader">
  <div id="maintitle">
	<h1> <a href="../../../../index.html" title="Castle Project Home" accesskey="1">Home</a> </h1>
	<h2> <a href="http://www.castlestronghold.com" title="Castle Stronghold: support, consulting and development">Castle Stronghold</a> </h2>
  </div>
  <div id="mainbar">
	<ul id="toplinks">
		<li>&nbsp;</li>
		<li><a style="_width: 70px;" href="../../../../index.html">Home</a></li>
		<li><a style="_width: 70px;" href="../../../../castle/download.html">Download</a></li>
		<li><a style="_width: 110px;" href="http://api.castleproject.org">API Doc</a></li>
		<li><a style="_width: 50px;" href="http://using.castleproject.org">Using</a></li>
		<li><a style="_width: 60px;" href="../../../../community/forum.html">Forum</a></li>
		<li><a style="_width: 120px;" href="../../../../jira.html">Jira/Issue tracker</a></li>
		<li><a style="_width: 110px;" href="http://builds.castleproject.org">Builds</a></li>
	</ul>
  </div>
</div>



<div id="coolpage">

	<div id="sidebar" >
		
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../activerecord/index.html">ActiveRecord</a>
</span>
  <ul>
<li>
<a href="./../../../../activerecord/gettingstarted/index.html">Getting started</a>
</li>
<li>
<a href="./../../../../activerecord/faq.html">FAQ</a>
</li>
<li>
<a href="./../../../../activerecord/recipes/index.html">Recipes</a>
</li>
<li>
<a href="./../../../../activerecord/externalarticles.html">External Articles</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../activerecord/documentation/trunk/index.html">Documentation</a>
</span>
  <ul>
<li>
<a href="./../../../../activerecord/documentation/trunk/releasenotes/index.html">Release notes</a>
</li>
<li>
<a href="./../../../../activerecord/documentation/trunk/manual/index.html">Reference Manual</a>
</li>
<li>
<a href="./../../../../activerecord/documentation/trunk/usersguide/index.html">User's Guide</a>
</li>
<li>
<a href="./../../../../activerecord/documentation/trunk/advanced/index.html">Advanced usage</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="darkmenu">
    <div class="darkmenucontent">
<span class="menutitle">
Navigation
</span>
  <ul>
<li>
<a href="./../../../../index.html">Back to Main Page</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
	<br/>
	
	</div>
		
	<div id="content">
	
		<div class="callout-pic">

<!-- Begin Table of contents -->
<div id="toc">
<h2>Table of contents</h2>
<ul>
<li class='toclevel-1'><a href="#ISessionFactoryHolder"><span class="tocnumber">1</span> <span class="toctext">Understanding the internals</span></a>
</li>
<li class='toclevel-1'><a href="#ISessionScope"><span class="tocnumber">2</span> <span class="toctext">ISessionScope</span></a>
</li>
<li class='toclevel-1'><a href="#UnderstandingSessionScope"><span class="tocnumber">3</span> <span class="toctext">Understanding SessionScope</span></a>
<ul>
	<li class='toclevel-1'><span class="tocnumber">3.1</span> <span class="toctext">First level cache</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">3.2</span> <span class="toctext">Batching changes</span>
</li>
	<li class='toclevel-1'><span class="tocnumber">3.3</span> <span class="toctext">Possible unexpected behavior</span>
</li>
</ul>
</li>
<li class='toclevel-1'><a href="#Advanced"><span class="tocnumber">4</span> <span class="toctext">Read only Scopes</span></a>
</li>
</ul>
</div>
<!-- End Table of contents -->
		</div>

		<h1 class="firstHeading">
		    Understanding Scopes
		</h1> 
	
<div class="breadcrumbs">
&raquo;
	<a href="./../../../../index.html">Home</a> 
&raquo;
	<a href="./../../../../activerecord/index.html">ActiveRecord</a> 
&raquo;
	<a href="./../../../../activerecord/documentation/index.html">Documentation</a> 
&raquo;
	<a href="./../../../../activerecord/documentation/trunk/index.html">ActiveRecord trunk Documentation</a> 
&raquo;
	<a href="./../../../../activerecord/documentation/trunk/manual/index.html">Reference Manual</a> 
&raquo;
<u>Understanding Scopes</u>
</div>

		<!-- start content -->
<p>
Any database related operation on ActiveRecord  
ultimately delegates the task to NHibernate and basically 
all NHibernate operation demands an
<tt>ISession</tt> instance. 
</p><p>
When ActiveRecord is about to delegate something to NHibernate 
it checks if there is a <tt>ISession</tt> instance available and
if not, one is created and disposed as soon as the operation is completed.
</p><p>
A SessionScope is a way to encapsulate and extend the life
of a NHibernate's <tt>ISession</tt> instance. Once one is active,
when ActiveRecord checks for an <tt>ISession</tt> instance, the scope is found
and from that point on it is in charge of providing the session.
</p><p>
It is adamant that you know the basics of what is the purpose of 
NHibernate <tt>ISession</tt>, the <tt>Flush</tt> operation and supported
<tt>Flush</tt> behaviors. Please take a moment to read 
<a href="http://www.hibernate.org/5.html#A17" >NHibernate documentation</a>.
</p><p>
If you're familiar with the Unit of Work pattern, then consider a <tt>ISession</tt>
a unit of work interaction with the database. NHibernate, however, is smart enough
to flush changes whenever it decides it needs to. For instance, before sending a query 
to the database. 
</p><p>
That might lead to unexpected results. That's why it's important to understand
how things work and then design your solution appropriately.
</p><a name="ISessionFactoryHolder"></a>
  <h1>Understanding the internals</h1>
<p>
	The <tt>ISessionFactoryHolder</tt> interface 
	implementation holds and manages one or more session factories (one 
	per database configured).
	Any ActiveRecord operation invokes <tt>CreateSession</tt> and 
	<tt>ReleaseSession</tt>, for example:
	</p>    <pre class="csharpcode">

<span class="kwrd">protected</span> <span class="kwrd">internal</span> <span class="kwrd">static</span> Array FindAll(Type targetType, Order[] orders, <span class="kwrd">params</span> ICriterion[] criterias)
{
    ISession session = holder.CreateSession(targetType);
    
    <span class="kwrd">try</span>
    {
        <span class="rem">// implementation omitted for clarity</span>
    }
    <span class="kwrd">catch</span>(ValidationException)
    {
        <span class="kwrd">throw</span>;
    }
    <span class="kwrd">catch</span>(Exception ex)
    {
        <span class="kwrd">throw</span> <span class="kwrd">new</span> ActiveRecordException(<span class="str">"Could not perform FindAll for "</span> + targetType.Name, ex);
    }
    <span class="kwrd">finally</span>
    {
        holder.ReleaseSession(session);
    }
}</pre>
  <p>
	The holder implementation always checks for a registered 
	scope. 
	</p>    <pre class="csharpcode">

[MethodImpl(MethodImplOptions.Synchronized)]
<span class="kwrd">public</span> ISession CreateSession(Type type)
{
    <span class="kwrd">if</span> (threadScopeInfo.HasInitializedScope)
    {
        <span class="kwrd">return</span> CreateScopeSession(type);
    }

    ISessionFactory sessionFactory = GetSessionFactory(type);

    ISession session = OpenSession(sessionFactory);

    System.Diagnostics.Debug.Assert( session != <span class="kwrd">null</span> );

    <span class="kwrd">return</span> session;
}</pre>
  <a name="ISessionScope"></a>
  <h1>ISessionScope</h1>
<p>
	The <tt>ISessionScope</tt> interface 
	defines the contract for possible scope implementations. All
	scopes must have a fixed type that defines its semantic.
	</p><p>
	We have three built-in supported scopes:
	
	<ul><li><tt>SessionScope</tt>: Keeps a <tt>ISession</tt> instance alive, 
	thus maximizing the performance by providing a first level cache, batching operations
	and allowing lazy load to work</li><li><tt>TransactionMode</tt>: Defines the scope of a transaction. Can be nested within a SessionScope and even between multiple transactions.</li><li><tt>DifferentDatabaseScope</tt>: replaces the connection used by NHibernate with one provided
	by your code, thus forcing the underlying operations to happen in a different database</li></ul></p><a name="UnderstandingSessionScope"></a>
  <h1>Understanding SessionScope</h1>
<p>
	The <tt>SessionScope</tt> should always be used on real apps built using ActiveRecord.
	It allows lazy load relations to work, it batches operations and provides a first level cache. 
	</p>  <h2>First level cache</h2>
<p>
		Consider the following code:
		</p>    <pre class="csharpcode">

TODO
</pre>
    <h2>Batching changes</h2>
<p>
		Consider the following code:
		</p>    <pre class="csharpcode">

TODO
</pre>
    <h2>Possible unexpected behavior</h2>
<p>
		Consider the following code:
		</p>    <pre class="csharpcode">

TODO
</pre>
  <a name="Advanced"></a>
  <h1>Read only Scopes</h1>
<p>
	A NHibernate <tt>ISession</tt> manages the changes made to entities 
	and <tt>Flush</tt> them in some situations. If your process 
	performs lots of read, and is not supposed to write, or you want to decide
	when a write should be performed, then you should create a <tt>SessionScope</tt>
	that does not perform <tt>Flush</tt>.
	</p>    <pre class="csharpcode">

<span class="kwrd">using</span>(<span class="kwrd">new</span> SessionScope(FlushAction.Never))
{
    <span class="rem">// lots of operations db related here</span>
}</pre>
  <p>
	For these cases performance will be greatly improved. However
	it is up to you to manage the <tt>Flush</tt>:
	</p>    <pre class="csharpcode">

<span class="kwrd">using</span>(<span class="kwrd">new</span> SessionScope(FlushAction.Never))
{
    <span class="rem">// lots of operations</span>

    <span class="rem">// Everything is OK, flush the changes</span>
    SessionScope.Current.Flush();
}</pre>
  <p>
	At the same time, NHibernate is keeping tracks of changes to objects within 
	the scope. If there are too many objects and too many changes to keep track,
	then performance will slowly downgrade. So a flushing now and then will be required.
	</p>		<!-- end content -->

<script type="text/javascript"><!--
google_ad_client = "pub-2091974950947714";
/* 728x90, created 2/13/08 */
google_ad_slot = "5378217716";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
		
	<div id="footer">
	Found an error? Something inaccurate? 
	<a href="../../../../community/getinvolved.html">Help us improve the documentation</a> <br/>
	Generated by <a href="../../../../others/anakia/index.html">Castle Anakia</a>. 
	
	<p>&nbsp;</p>
	
	<p>
	Sponsored by <img src="../../../../images/logothumb.gif" /> <a href="http://www.castlestronghold.com">Castle Stronghold</a>.
	</p>
	
	</div>

	<!-- Search Google -->
<center>
<FORM method=GET action="http://www.google.com/custom">
<TABLE bgcolor="#FFFFFF" cellspacing="4" border="0" style="border: solid 1px gray;" align="center">
<tr valign=top><td>
<A HREF="http://www.google.com/search">
<IMG SRC="http://www.google.com/logos/Logo_40wht.gif" border=0 ALT=Google align=middle></A>
</td>
<td>
<INPUT TYPE=text name=q size=31 maxlength=255 value="">
<INPUT type=submit name=sa VALUE="Google Search">
<INPUT type=hidden name=cof VALUE="S:http://www.castlestronghold.com;GL:1;VLC:#373737;AH:center;LH:63;LC:#0A50A1;GFNT:#5B5B5B;L:http://www.castleproject.org/images/castle-logo.gif;ALC:#0A50A1;BIMG:http://www.castleproject.org/images/bg.png;LW:280;T:#5B5B5B;AWFID:3d565acacdd9f388;">
<input type=hidden name=domains value="castleproject.org"><br><input type=radio name=sitesearch value=""> Search WWW <input type=radio name=sitesearch value="castleproject.org" checked> Search castleproject.org
</td></tr></TABLE>
</FORM>
<!-- Search Google -->
</center>
	&nbsp;
	<br/>

		</div> <!-- end of content -->
  </div><!-- end of page -->
  


	<script type="text/javascript">_uacct = "UA-1190612-1";urchinTracker();</script>
	</body>
</html>
