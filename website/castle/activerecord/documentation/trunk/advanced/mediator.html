<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">









<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
		<title>Using ActiveRecord without a base class :: Castle Project</title>
		<link rel="stylesheet" href="../../../../base.css" />
		<link rel="stylesheet" href="../../../../front.css" />
		<link rel="stylesheet" href="../../../../elem.css" />
		<link rel="stylesheet" href="../../../../csharp.css" />
		<link rel="stylesheet" href="../../../../TAB_styles.css" />
		<script type="text/javascript" src="../../../../mktree.js"></script>
		<script type="text/javascript" src="../../../../TAB_Function_Lib.js"></script>
		<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script>
	</head>

	<body>
<div id="topheader">
  <div id="maintitle">
	<h1> <a href="../../../../index.html" title="Castle Project Home" accesskey="1">Home</a> </h1>
	<h2> <a href="http://www.castlestronghold.com" title="Castle Stronghold: support, consulting and development">Castle Stronghold</a> </h2>
  </div>
  <div id="mainbar">
	<ul id="toplinks">
		<li>&nbsp;</li>
		<li><a style="_width: 70px;" href="../../../../index.html">Home</a></li>
		<li><a style="_width: 70px;" href="../../../../castle/projects.html">Projects</a></li>
		<li><a style="_width: 70px;" href="../../../../castle/download.html">Downloads</a></li>
		<li><a style="_width: 110px;" href="http://api.castleproject.org">API Doc</a></li>
		<li><a style="_width: 50px;" href="http://using.castleproject.org">Using</a></li>
		<li><a style="_width: 60px;" href="../../../../community/mailinglists.html">Mailing Lists</a></li>
		<li><a style="_width: 120px;" href="../../../../issuetracker.html">Issue Tracker</a></li>
		<li><a style="_width: 110px;" href="http://builds.castleproject.org">Builds</a></li>
	</ul>
  </div>
</div>



<div id="coolpage">

	<div id="sidebar" >
		
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../activerecord/index.html">ActiveRecord</a>
</span>
  <ul>
<li>
<a href="./../../../../activerecord/gettingstarted/index.html">Getting started</a>
</li>
<li>
<a href="./../../../../activerecord/faq.html">FAQ</a>
</li>
<li>
<a href="./../../../../activerecord/recipes/index.html">Recipes</a>
</li>
<li>
<a href="./../../../../activerecord/externalarticles.html">External Articles</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../activerecord/documentation/trunk/index.html">Documentation</a>
</span>
  <ul>
<li>
<a href="./../../../../activerecord/documentation/trunk/releasenotes/index.html">Release notes</a>
</li>
<li>
<a href="./../../../../activerecord/documentation/trunk/manual/index.html">Reference Manual</a>
</li>
<li>
<a href="./../../../../activerecord/documentation/trunk/usersguide/index.html">User's Guide</a>
</li>
<li>
<a href="./../../../../activerecord/documentation/trunk/advanced/index.html">Advanced usage</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="darkmenu">
    <div class="darkmenucontent">
<span class="menutitle">
Navigation
</span>
  <ul>
<li>
<a href="./../../../../index.html">Back to Main Page</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
	<br/>
	
	</div>
		
	<div id="content">
	
		<div class="callout-pic">

<!-- Begin Table of contents -->
<div id="toc">
<h2>Table of contents</h2>
<ul>
<li class='toclevel-1'><a href="#basicops"><span class="tocnumber">1</span> <span class="toctext">Basic Operations</span></a>
</li>
<li class='toclevel-1'><a href="#validation"><span class="tocnumber">2</span> <span class="toctext">Validation Support</span></a>
</li>
<li class='toclevel-1'><a href="#callbacks"><span class="tocnumber">3</span> <span class="toctext">Providing Callbacks</span></a>
</li>
<li class='toclevel-1'><a href="#repository"><span class="tocnumber">4</span> <span class="toctext">The ActiveRecordMediator as a Repository</span></a>
</li>
</ul>
</div>
<!-- End Table of contents -->
		</div>

		<h1 class="firstHeading">
		    Using ActiveRecord without a base class
		</h1> 
	
<div class="breadcrumbs">
&raquo;
	<a href="./../../../../index.html">Home</a> 
&raquo;
	<a href="./../../../../activerecord/index.html">ActiveRecord</a> 
&raquo;
	<a href="./../../../../activerecord/documentation/index.html">Documentation</a> 
&raquo;
	<a href="./../../../../activerecord/documentation/trunk/index.html">ActiveRecord trunk Documentation</a> 
&raquo;
	<a href="./../../../../activerecord/documentation/trunk/advanced/index.html">Advanced usage</a> 
&raquo;
<u>Using ActiveRecord without a base class</u>
</div>

		<!-- start content -->
<p>
				Castle ActiveRecord offers a lot of functionality in persisting objects: It allows to use
				NHibernate without requiring to maintain XML mapping files, it manages sessions and its
				integration into MonoRail simplifies using web applications.
			</p><p>
				One constraint that was found to hinder using ActiveRecord in practice was the requirement
				to inherit from a certain base class. Given the fact that multiple inheritance is not
				possible in .Net, the need for a base class is very problematic.
			</p><p>
				And while the active record pattern is especially useful for creating data-driven applications,
				there are use cases where it is not adequate. Especially when adopting Domain Driven Design,
				there remains considerable debate whether ActiveRecord should be banned from the domain layer
				altogether. Although only removing the base class from ActiveRecord types does not make them
				persistance ignorant or deals with other problematic factors like the dominance of properties,
				it avoids attaching persistance behaviour to the classes.
			</p><p>
				Stripped of the persistance related methods, ActiveRecord types can be used as domain
				classes. This is still questionable, but a practical way to accomplish transition from
				a data-driven to a domain-driven approach. 
			</p><p>
				Without persistance behaviour, ActiveRecord types can also be used as a DTOs 
				(Data Transfer Objects) across the application. Methods like <tt>Create()</tt> or <tt>Delete()</tt>
				should not be present in DTOs since they distract the client code developer from using the
				applications services. A plain serializable object on the other hand can be filled with data and
				passed to the application layer which will use it to execute the required domain logic in the
				domain layer.
			</p><a name="basicops"></a>
  <h1>Basic Operations</h1>
<p>
				The basic operations are present in the <tt>ActiveRecordMediator</tt> class. This is a generic class
				that contains static methods providing the same functionality as <tt>ActiveRecordBase</tt> concerning
				basic operations discussed in <a href="../usersguide/lifecycle.html" >lifecycle</a> article.
			</p><p>
				The following example shows the usage of <tt>ActiveRecordMediator</tt>:
			</p>    <pre class="csharpcode">

<span class="rem">// Create</span>
Customer c = <span class="kwrd">new</span> Customer();
c.Name = <span class="str">"Mr. Johnson"</span>;
c.Address = String.Empty;
ActiveRecordMediator&lt;Customer&gt;.Save(c);

<span class="rem">// Read/Update</span>

Customer loaded = ActiveRecordMediator&lt;Customer&gt;.FindOne(Expression.Eq(<span class="str">"Name"</span>, <span class="str">"Mr. Johnson"</span>));
loaded.Address = <span class="str">"Middle of the Road"</span>;
ActiveRecordMediator&lt;Customer&gt;.Save(loaded);

<span class="rem">// Delete</span>

ActiveRecordMediator&lt;Customer&gt;.Delete(c);            
</pre>
  <p>
				All information about the lifecycle, sessions and transactions are still valid, only the
				calls to perform ActiveRecord operations has changed.
			</p><a name="validation"></a>
  <h1>Validation Support</h1>
<p>
				Another consequence of not using a base class is missing validation support. The 
				<tt>ActiveRecordValidationBase</tt> offers an <tt>IsValid()</tt> and ActiveRecord denies
				flushing changes if an entity inheriting from this base class is not valid.
			</p><p>
				Without using the base class, this functionality is void. Only database constraints are
				still effective. These constraints are defined within the Property or Field attribute and
				allow only basic validations.
			</p><p>
				However, Castle's Validation support is not gone, but it must be invoked explicitly instead.
			</p><p>
				The following example shows how this is done:
			</p>    <pre class="csharpcode">

<span class="rem">// Entity</span>
[ActiveRecord]
<span class="kwrd">public</span> <span class="kwrd">class</span> Customer
{
        <span class="kwrd">private</span> Guid id;

        [PrimaryKey(PrimaryKeyType.GuidComb)]
        <span class="kwrd">public</span> Guid Id
        {
                get { <span class="kwrd">return</span> id; }
                set { id = <span class="kwrd">value</span>; }
        }
        <span class="kwrd">private</span> <span class="kwrd">string</span> name;

        [Property(Unique=<span class="kwrd">true</span>,NotNull=<span class="kwrd">true</span>)]
        [ValidateNonEmpty]
        [ValidateIsUnique]
        <span class="kwrd">public</span> <span class="kwrd">string</span> Name
        {
                get { <span class="kwrd">return</span> name; }
                set { name = <span class="kwrd">value</span>; }
        }
        <span class="kwrd">private</span> <span class="kwrd">string</span> address;

        [Property(NotNull=<span class="kwrd">true</span>)]
        [ValidateNonEmpty]
        <span class="kwrd">public</span> <span class="kwrd">string</span> Address
        {
                get { <span class="kwrd">return</span> address; }
                set { address = <span class="kwrd">value</span>; }
        }
}    

<span class="rem">// using code</span>
Customer c = <span class="kwrd">new</span> Customer();
c.Name = <span class="str">"Mr. Johnson"</span>;
c.Address = String.Empty;

IValidatorRunner runner = 
        <span class="kwrd">new</span> ValidatorRunner(<span class="kwrd">new</span> CachedValidationRegistry());
<span class="kwrd">if</span> (runner.IsValid(c))
        ActiveRecordMediator&lt;Customer&gt;.Save(c);
<span class="kwrd">else</span>
        <span class="kwrd">foreach</span> (<span class="kwrd">string</span> msg <span class="kwrd">in</span> runner.GetErrorSummary(c).ErrorMessages)
                Console.WriteLine(msg);
</pre>
  <a name="callbacks"></a>
  <h1>Providing Callbacks</h1>
<p>
				The class <tt>ActiveRecordHooksBase</tt> which is base class of <tt>ActiveRecordBase</tt>
				provides a couple of methods to hook into ActiveRecord's lifecycle management. Classes that
				do not inherit from <tt>ActiveRecordBase</tt> do not offer these hooks.
			</p><p>
				In order to hook into the lifecycle, it is possible to use the strategies that NHibernate offers.
				Since NHibernate works only on plain classes, these methods are also suitable for ActiveRecord-types
				without a base class.
			</p><p>
				The two possibilities are:
			</p><ul><li><strong>Interceptors: </strong>Interceptors implement the interface <tt>IInterface</tt>, which
					defines roughly the same hooks as <tt>ActiveRecordHooksBase</tt>. Interceptors must be registered
					with the session used.
				</li><li><strong>Events: </strong>The event system was introduced in NHibernate 2.0. It replaces interceptors
					and offers a more modular approach to hooking into the lifecycle. For all hooks events are fired
					from within NHibernate. Any event listener registered will be notified of the event and can
					act accordingly.
				</li></ul>  <div class="note">
<div class="notetopbg">
<div class="noteborderleft">
<div class="noteborderright">
<div class="notetopleft">
<div class="notetopright">
<div class="notebottomleft">
<div class="notebottomright">
<div class="boxtitle">Quick Note</div>
<div class="innercontent">
<p>
					Events have the benefit that the listeners can be registered in the configuration. This allows
					to add them transparently to the application. <strong>ActiveRecord does not yet support the
					registration of event listeners in the configuration.</strong></p>
</div></div></div></div></div></div></div></div></div>
<p>
				The use of lifecycle callbacks, interceptors and events is discussed in a the article 
				<a href="hooks.html" >Hooks and lifecycle</a>.
			</p><a name="repository"></a>
  <h1>The ActiveRecordMediator as a Repository</h1>
<p>
				In addition to the persistence methods available many classic ActiveRecord entity types contain
				own persistence logic, for example static <tt>Find</tt>-methods that return entity collections
				based on the types special characteristics.
			</p><p>
				When the original persistance logic ActiveRecord offers, is removed from the entity, there is
				no good reason to put additional persistance logic in it, even if domain-driven development is
				not an issue.
			</p><p>
				Such methods belong together in a single class. This type of class is often called a 
				<strong>Repository</strong>. If a specialized repository implementation such as <tt>IRepository</tt>
				from <strong>Rhino Commons</strong> is not used, <tt>ActiveRecordMediator</tt> can be used to
				build custom repository types:
			</p>    <pre class="csharpcode">

<span class="kwrd">public</span> <span class="kwrd">class</span> CustomerRepo : ActiveRecordMediator&lt;Customer&gt;
{
        <span class="kwrd">public</span> <span class="kwrd">static</span> Customer[] FindByName(<span class="kwrd">string</span> name)
        {
                <span class="kwrd">return</span> FindAll(<span class="kwrd">new</span> ICriterion[]{Expression.Like(<span class="str">"Name"</span>, name,MatchMode.Anywhere)});
        }
}
</pre>
  <p>
				The repository can then be used exactly like the <tt>ActiveRecordMediator</tt> itself:
			</p>    <pre class="csharpcode">

<span class="rem">// Create</span>
Customer c = <span class="kwrd">new</span> Customer();
c.Name = <span class="str">"Mr. Johnson"</span>;
c.Address = String.Empty;
CustomerRepo.Save(c);

<span class="rem">// Read/Update</span>
Customer loaded = CustomerRepo.FindByName(<span class="str">"Johnson"</span>)[0];
loaded.Address = <span class="str">"Middle of the Road"</span>;
CustomerRepo.Save(loaded);

<span class="rem">// Delete</span>
CustomerRepo.Delete(loaded);
</pre>
  		<!-- end content -->
		
	<div id="footer">
<script type="text/javascript"><!--
google_ad_client = "pub-2091974950947714";
/* 728x90, created 2/13/08 */
google_ad_slot = "5378217716";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
	
	<br/>
	Found an error? Something inaccurate? 
	<a href="../../../../community/getinvolved.html">Help us improve the documentation</a> <br/>
	Generated by <a href="../../../../others/anakia/index.html">Castle Anakia</a>. 
	
	<p>&nbsp;</p>
	
	<p>
	Sponsored by <img src="../../../../images/logothumb.gif" /> <a href="http://www.castlestronghold.com">Castle Stronghold</a>.
	</p>
	
	</div>

	<!-- Search Google -->
<center>
<FORM method=GET action="http://www.google.com/custom">
<TABLE bgcolor="#FFFFFF" cellspacing="4" border="0" style="border: solid 1px gray;" align="center">
<tr valign=top><td>
<A HREF="http://www.google.com/search">
<IMG SRC="http://www.google.com/logos/Logo_40wht.gif" border=0 ALT=Google align=middle></A>
</td>
<td>
<INPUT TYPE=text name=q size=31 maxlength=255 value="">
<INPUT type=submit name=sa VALUE="Google Search">
<INPUT type=hidden name=cof VALUE="S:http://www.castlestronghold.com;GL:1;VLC:#373737;AH:center;LH:63;LC:#0A50A1;GFNT:#5B5B5B;L:http://www.castleproject.org/images/castle-logo.gif;ALC:#0A50A1;BIMG:http://www.castleproject.org/images/bg.png;LW:280;T:#5B5B5B;AWFID:3d565acacdd9f388;">
<input type=hidden name=domains value="castleproject.org"><br><input type=radio name=sitesearch value=""> Search WWW <input type=radio name=sitesearch value="castleproject.org" checked> Search castleproject.org
</td></tr></TABLE>
</FORM>
<!-- Search Google -->
</center>
	&nbsp;
	<br/>

		</div> <!-- end of content -->
  </div><!-- end of page -->
  


	<script type="text/javascript">_uacct = "UA-1190612-1";urchinTracker();</script>
	</body>
</html>
