<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">









<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
		<title>The Second Level Cache :: Castle Project</title>
		<link rel="stylesheet" href="../../../../base.css" />
		<link rel="stylesheet" href="../../../../front.css" />
		<link rel="stylesheet" href="../../../../elem.css" />
		<link rel="stylesheet" href="../../../../csharp.css" />
		<link rel="stylesheet" href="../../../../TAB_styles.css" />
		<script type="text/javascript" src="../../../../mktree.js"></script>
		<script type="text/javascript" src="../../../../TAB_Function_Lib.js"></script>
		<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script>
	</head>

	<body>
<div id="topheader">
  <div id="maintitle">
	<h1> <a href="../../../../index.html" title="Castle Project Home" accesskey="1">Home</a> </h1>
	<h2> <a href="http://www.castlestronghold.com" title="Castle Stronghold: support, consulting and development">Castle Stronghold</a> </h2>
  </div>
  <div id="mainbar">
	<ul id="toplinks">
		<li>&nbsp;</li>
		<li><a style="_width: 70px;" href="../../../../index.html">Home</a></li>
		<li><a style="_width: 70px;" href="../../../../castle/projects.html">Projects</a></li>
		<li><a style="_width: 70px;" href="../../../../castle/download.html">Downloads</a></li>
		<li><a href="#" onclick="UserVoice.Popin.show(); return false;" title="Uservoice Feedback">Feedback</a></li>
		<li><a style="_width: 110px;" href="http://api.castleproject.org">API Doc</a></li>
		<li><a style="_width: 50px;" href="http://using.castleproject.org">Using</a></li>
		<li><a style="_width: 60px;" href="../../../../community/mailinglists.html">Mailing Lists</a></li>
		<li><a style="_width: 120px;" href="../../../../issuetracker.html">Issue Tracker</a></li>
		<li><a style="_width: 110px;" href="http://builds.castleproject.org">Builds</a></li>
	</ul>
  </div>
</div>



<div id="coolpage">

	<div id="sidebar" >
		
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../activerecord/index.html">ActiveRecord</a>
</span>
  <ul>
<li>
<a href="./../../../../activerecord/gettingstarted/index.html">Getting started</a>
</li>
<li>
<a href="./../../../../activerecord/faq.html">FAQ</a>
</li>
<li>
<a href="./../../../../activerecord/recipes/index.html">Recipes</a>
</li>
<li>
<a href="./../../../../activerecord/externalarticles.html">External Articles</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="lightmenu">
    <div class="lightmenucontent">
<span class="menutitle">
<a href="./../../../../activerecord/documentation/v1rc1/index.html">Documentation</a>
</span>
  <ul>
<li>
<a href="./../../../../activerecord/documentation/v1rc1/releasenotes/index.html">Release notes</a>
</li>
<li>
<a href="./../../../../activerecord/documentation/v1rc1/manual/index.html">Reference Manual</a>
</li>
<li>
<a href="./../../../../activerecord/documentation/v1rc1/usersguide/index.html">User's Guide</a>
</li>
<li>
<a href="./../../../../activerecord/documentation/v1rc1/advanced/index.html">Advanced usage</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
  <div class="darkmenu">
    <div class="darkmenucontent">
<span class="menutitle">
Navigation
</span>
  <ul>
<li>
<a href="./../../../../index.html">Back to Main Page</a>
</li>
  </ul>
    </div>
  </div>
  <br/>
	<br/>
	
	</div>
		
	<div id="content">
	
		<div class="callout-pic">

<!-- Begin Table of contents -->
<div id="toc">
<h2>Table of contents</h2>
<ul>
<li class='toclevel-1'><a href="#NHibernate Caches"><span class="tocnumber">1</span> <span class="toctext">NHibernate Caches</span></a>
</li>
<li class='toclevel-1'><a href="#Choosing the second level cache"><span class="tocnumber">2</span> <span class="toctext">Choosing the second level cache</span></a>
</li>
<li class='toclevel-1'><a href="#Using the second level cache"><span class="tocnumber">3</span> <span class="toctext">Using the second level cache</span></a>
</li>
<li class='toclevel-1'><a href="#caching options for entities and collections"><span class="tocnumber">4</span> <span class="toctext">Caching options for entities and collections</span></a>
</li>
<li class='toclevel-1'><a href="#conclusion"><span class="tocnumber">5</span> <span class="toctext">Conclusion</span></a>
</li>
</ul>
</div>
<!-- End Table of contents -->
		</div>

		<h1 class="firstHeading">
		    The Second Level Cache
		</h1> 
	
<div class="breadcrumbs">
&raquo;
	<a href="./../../../../index.html">Home</a> 
&raquo;
	<a href="./../../../../activerecord/index.html">ActiveRecord</a> 
&raquo;
	<a href="./../../../../activerecord/documentation/index.html">Documentation</a> 
&raquo;
	<a href="./../../../../activerecord/documentation/v1rc1/index.html">ActiveRecord RC1 Documentation</a> 
&raquo;
	<a href="./../../../../activerecord/documentation/v1rc1/advanced/index.html">Advanced usage</a> 
&raquo;
<u>The Second Level Cache</u>
</div>

		<!-- start content -->
<p>
This article explains how to use the second level cache
</p><a name="NHibernate Caches"></a>
  <h1>NHibernate Caches</h1>
<p>
	NHibernate, by default, uses a first-level cache, or session-level cache. It means that, inside the same session, you can ask for the same object twice, and the database will be queried just once.
	</p><p>
	In addition, NHibernate also supports a second-level cache, or sessionfactory-level cache. It can cache object data among different sessions, drastically reducing the need for database queries.
	</p>  <div class="note">
<div class="notetopbg">
<div class="noteborderleft">
<div class="noteborderright">
<div class="notetopleft">
<div class="notetopright">
<div class="notebottomleft">
<div class="notebottomright">
<div class="boxtitle">Quick Note</div>
<div class="innercontent">
<p>
	While the second level cache is very powerful, we do not recommend using it as a crutch. Your applications should not require the second level cache in order to gain acceptable performance. Using the cache in this manner usually indicate of a general problem in the way the data is handled in the application, with the cache acting as a band-aid. You should always be aware of how much each operation costs.
	</p>
</div></div></div></div></div></div></div></div></div>
<a name="Choosing the second level cache"></a>
  <h1>Choosing the second level cache</h1>
<p>
	NHibernate has several second level caches to choose from. The most common one is the SysCache, which is using the ASP.Net cache to store the cached data. This cache is a local cache, and should not be used in a web farms scenarios. For those scenarios, the MemCached cache should be used. For more information about the different cache provider implementations, please refer to the <a href="http://nhibernate.sourceforge.net/nh-docs/html/NHibernate.Caches.html" >NHibernate caching documenation</a>.
	</p>  <div class="warning">
<div class="warningtopbg">
<div class="warningborderleft">
<div class="warningborderright">
<div class="warningtopleft">
<div class="warningtopright">
<div class="warningbottomleft">
<div class="warningbottomright">
	<div class="boxtitle">Warning</div>
<div class="innercontent">
<p>
	Before starting to use the second level cache, make sure that you understand how it works! It can become particulary dangerous when your database is changed from outside NHibernate: either manually or by other applications.
	</p>
</div></div></div></div></div></div></div></div></div>
<a name="Using the second level cache"></a>
  <h1>Using the second level cache</h1>
<p>Within ActiveRecord configuration (Enabling the SysCache with an expiry of 300 seconds)</p><p>    <pre class="csharpcode">

<span class="kwrd">&lt;</span><span class="html">config</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">key</span><span class="kwrd">="hibernate.connection.driver_class"</span> <span class="attr">value</span><span class="kwrd">="NHibernate.Driver.SqlClientDriver"</span> <span class="kwrd">/&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">key</span><span class="kwrd">="hibernate.dialect"</span> <span class="attr">value</span><span class="kwrd">="NHibernate.Dialect.MsSql2000Dialect"</span> <span class="kwrd">/&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">key</span><span class="kwrd">="hibernate.connection.provider"</span> <span class="attr">value</span><span class="kwrd">="NHibernate.Connection.DriverConnectionProvider"</span> <span class="kwrd">/&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">key</span><span class="kwrd">="hibernate.connection.connection_string"</span> <span class="attr">value</span><span class="kwrd">="Data Source=.;Initial Catalog=myapp_db;Integrated Security=SSPI"</span> <span class="kwrd">/&gt;</span>

  <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">key</span><span class="kwrd">="hibernate.cache.provider_class"</span> <span class="attr">value</span><span class="kwrd">="NHibernate.Caches.SysCache.SysCacheProvider,NHibernate.Caches.SysCache"</span> <span class="kwrd">/&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">key</span><span class="kwrd">="relativeExpiration"</span> <span class="attr">value</span><span class="kwrd">="300"</span> <span class="kwrd">/&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">config</span><span class="kwrd">&gt;</span>
    </pre>
  </p><p>
	Reference the assemblies that implements cache support. For the configuration above:
    <ul><li> NHibernate.Caches.SysCache.dll </li></ul></p><p>
	Regardless of the cache provider used, NHibernate has three seperate caches that is uses (without counting cache regions, which are user defined). The entity values cache, the collections cache and the query cache. When you enable the second level cache, you enable it for the entities and the collections that choose to be cached. You need to explicitly define which queries you want cached. Note that in general, it is not recommended to enable the query cache (because of stale results from the queries), refer to NHibernate's documenation for the details.
	</p><a name="caching options for entities and collections"></a>
  <h1>Caching options for entities and collections</h1>
<p>Enabling the cache for an entity:
	    <pre class="csharpcode">

[ActiveRecord( Cache=CacheEnum.ReadOnly )]
<span class="kwrd">public</span> <span class="kwrd">class</span> Language : ActiveRecordBase 
    </pre>
  </p><p>Enabling the cache for a collection
	    <pre class="csharpcode">

[HasMany(.... , Cache=CacheEnum.ReadWrite)]
.... 

[HasAndBelongsToMany(.... , Cache=CacheEnum.ReadOnly)]
....
    </pre>
  
	Again, you should investigate NHibernate documenation for the caching options and their implications
	</p><a name="conclusion"></a>
  <h1>Conclusion</h1>
<p>
This is all you need to do to enable the cache, NHibernate will automatically fetch items from the second level cache rather then the database when they are present there. This usually drastically reduce the number of queries made to the database, but it also increase the staleness of the data that the application has. Consider the implications carefully before you start using it.
</p>		<!-- end content -->
		
	<div id="footer">
<script type="text/javascript"><!--
google_ad_client = "pub-2091974950947714";
/* 728x90, created 2/13/08 */
google_ad_slot = "5378217716";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
	
	<br/>
	Found an error? Something inaccurate? 
	<a href="../../../../community/getinvolved.html">Help us improve the documentation</a> <br/>
	Generated by <a href="../../../../others/anakia/index.html">Castle Anakia</a>. 
	
	<p>&nbsp;</p>
	
	<p>
	Sponsored by <img src="../../../../images/logothumb.gif" /> <a href="http://www.castlestronghold.com">Castle Stronghold</a>.
	</p>
	
	</div>

	<!-- Search Google -->
<center>
<FORM method=GET action="http://www.google.com/custom">
<TABLE bgcolor="#FFFFFF" cellspacing="4" border="0" style="border: solid 1px gray;" align="center">
<tr valign=top><td>
<A HREF="http://www.google.com/search">
<IMG SRC="http://www.google.com/logos/Logo_40wht.gif" border=0 ALT=Google align=middle></A>
</td>
<td>
<INPUT TYPE=text name=q size=31 maxlength=255 value="">
<INPUT type=submit name=sa VALUE="Google Search">
<INPUT type=hidden name=cof VALUE="S:http://www.castlestronghold.com;GL:1;VLC:#373737;AH:center;LH:63;LC:#0A50A1;GFNT:#5B5B5B;L:http://www.castleproject.org/images/castle-logo.gif;ALC:#0A50A1;BIMG:http://www.castleproject.org/images/bg.png;LW:280;T:#5B5B5B;AWFID:3d565acacdd9f388;">
<input type=hidden name=domains value="castleproject.org"><br><input type=radio name=sitesearch value=""> Search WWW <input type=radio name=sitesearch value="castleproject.org" checked> Search castleproject.org
</td></tr></TABLE>
</FORM>
<!-- Search Google -->
</center>
	&nbsp;
	<br/>

		</div> <!-- end of content -->
  </div><!-- end of page -->
  


	<script type="text/javascript">_uacct = "UA-1190612-1";urchinTracker();</script>
	<script type="text/javascript">
		var uservoiceJsHost = ("https:" == document.location.protocol) ? "https://uservoice.com" : "http://cdn.uservoice.com";
		document.write(unescape("%3Cscript src='" + uservoiceJsHost + "/javascripts/widgets/tab.js' type='text/javascript'%3E%3C/script%3E"))
	</script>
	<script type="text/javascript">
		UserVoice.Popin.setup({ 
			key: 'castle',
			alignment: 'right',
			host: 'castle.uservoice.com', 
			forum: 'general', 
			lang: 'en'
		})
	</script>
	</body>
</html>
